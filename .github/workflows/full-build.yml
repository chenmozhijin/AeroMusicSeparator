name: Full Build CI

on:
  pull_request:
  push:
    branches: [main, master]
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      run_cuda:
        description: Run CUDA native jobs
        required: false
        default: true
        type: boolean
      build_jobs:
        description: Parallel build jobs (auto or integer)
        required: false
        default: auto
        type: string

concurrency:
  group: full-build-${{ github.ref }}
  cancel-in-progress: true

env:
  AMS_FFMPEG_VERSION: n7.1.1
  AMS_LAME_VERSION: '3.100'
  BUILD_JOBS_INPUT: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.build_jobs || 'auto' }}

jobs:
  prepare-ffmpeg:
    name: ffmpeg-${{ matrix.id }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - id: linux-x86_64
            os: ubuntu-24.04
            platform: linux
            artifact_name: ffmpeg-linux-x86_64
            artifact_path: aero_music_separator/native/third_party/ffmpeg/linux/x86_64
            run_cmd: ./aero_music_separator/native/tools/ffmpeg/build_linux.sh x86_64
          - id: windows-x64
            os: windows-2025
            platform: windows
            artifact_name: ffmpeg-windows-x64
            artifact_path: aero_music_separator/native/third_party/ffmpeg/windows/x64
            run_cmd: .\aero_music_separator\native\tools\ffmpeg\build_windows.ps1 -Arch x64
          - id: macos-x86_64
            os: macos-13
            platform: macos
            artifact_name: ffmpeg-macos-x86_64
            artifact_path: aero_music_separator/native/third_party/ffmpeg/macos/x86_64
            run_cmd: ./aero_music_separator/native/tools/ffmpeg/build_macos.sh x86_64
          - id: macos-arm64
            os: macos-14
            platform: macos
            artifact_name: ffmpeg-macos-arm64
            artifact_path: aero_music_separator/native/third_party/ffmpeg/macos/arm64
            run_cmd: ./aero_music_separator/native/tools/ffmpeg/build_macos.sh arm64
          - id: ios-device-sim-arm64
            os: macos-14
            platform: ios
            artifact_name: ffmpeg-ios-device-sim-arm64
            artifact_path: aero_music_separator/native/third_party/ffmpeg/ios
            run_cmd: ./aero_music_separator/native/tools/ffmpeg/build_ios.sh arm64
          - id: android-arm64-v8a
            os: ubuntu-24.04
            platform: android
            artifact_name: ffmpeg-android-arm64-v8a
            artifact_path: aero_music_separator/native/third_party/ffmpeg/android/arm64-v8a
            run_cmd: ./aero_music_separator/native/tools/ffmpeg/build_android.sh arm64-v8a
          - id: android-armeabi-v7a
            os: ubuntu-24.04
            platform: android
            artifact_name: ffmpeg-android-armeabi-v7a
            artifact_path: aero_music_separator/native/third_party/ffmpeg/android/armeabi-v7a
            run_cmd: ./aero_music_separator/native/tools/ffmpeg/build_android.sh armeabi-v7a
          - id: android-x86_64
            os: ubuntu-24.04
            platform: android
            artifact_name: ffmpeg-android-x86_64
            artifact_path: aero_music_separator/native/third_party/ffmpeg/android/x86_64
            run_cmd: ./aero_music_separator/native/tools/ffmpeg/build_android.sh x86_64

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Linux deps
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            autoconf \
            automake \
            libtool \
            pkg-config \
            make \
            nasm \
            yasm \
            python3 \
            cmake \
            ninja-build \
            curl \
            git

      - name: Install macOS deps
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install autoconf automake libtool pkg-config nasm yasm sccache

      - name: Setup MSYS2 (Windows)
        if: runner.os == 'Windows'
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            base-devel
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-autotools
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-make
            mingw-w64-x86_64-nasm
            mingw-w64-x86_64-yasm
            mingw-w64-x86_64-pkgconf
            mingw-w64-x86_64-python

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Cache ffmpeg sources/build
        uses: actions/cache@v4
        with:
          path: |
            .cache/ffmpeg-src
            .cache/ffmpeg-build
            ~/.cache/sccache
            ~/Library/Caches/Mozilla.sccache
            ~\AppData\Local\Mozilla\sccache
          key: ffmpeg-${{ matrix.id }}-${{ env.AMS_FFMPEG_VERSION }}-${{ env.AMS_LAME_VERSION }}-${{ hashFiles('aero_music_separator/native/tools/ffmpeg/**') }}

      - name: Setup Android SDK
        if: matrix.platform == 'android'
        uses: android-actions/setup-android@v3

      - name: Install Android NDK
        if: matrix.platform == 'android'
        run: sdkmanager "ndk;27.2.12479018"

      - name: Build ffmpeg (Unix)
        if: runner.os != 'Windows'
        shell: bash
        env:
          ANDROID_NDK_HOME: /usr/local/lib/android/sdk/ndk/27.2.12479018
          AMS_USE_SCCACHE: ${{ matrix.platform == 'android' && 'OFF' || 'ON' }}
        run: |
          chmod +x aero_music_separator/native/tools/ffmpeg/*.sh
          ${{ matrix.run_cmd }}

      - name: Build ffmpeg (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: ${{ matrix.run_cmd }}

      - name: sccache stats (Unix)
        if: runner.os != 'Windows'
        run: sccache --show-stats || true

      - name: sccache stats (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: sccache --show-stats

      - name: Verify ffmpeg manifest license profile (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          python3 aero_music_separator/native/tools/ffmpeg/verify_manifest_license.py \
            --manifest "${{ matrix.artifact_path }}/manifest.json"

      - name: Verify ffmpeg manifest license profile (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          python aero_music_separator/native/tools/ffmpeg/verify_manifest_license.py `
            --manifest "${{ matrix.artifact_path }}/manifest.json"

      - name: Upload ffmpeg artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ matrix.artifact_path }}
          if-no-files-found: error
          retention-days: 7

  openmp-native-verify:
    name: openmp-native-${{ matrix.id }}
    needs: prepare-ffmpeg
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - id: linux-vulkan
            os: ubuntu-24.04
            backend: vulkan
            ggml_cuda: 'OFF'
            ggml_vulkan: 'ON'
            ggml_metal: 'OFF'
            ffmpeg_artifact: ffmpeg-linux-x86_64
            ffmpeg_root: aero_music_separator/native/third_party/ffmpeg/linux/x86_64
          - id: windows-vulkan
            os: windows-2025
            backend: vulkan
            ggml_cuda: 'OFF'
            ggml_vulkan: 'ON'
            ggml_metal: 'OFF'
            ffmpeg_artifact: ffmpeg-windows-x64
            ffmpeg_root: aero_music_separator/native/third_party/ffmpeg/windows/x64
          - id: macos-metal
            os: macos-13
            backend: metal
            ggml_cuda: 'OFF'
            ggml_vulkan: 'OFF'
            ggml_metal: 'ON'
            ffmpeg_artifact: ffmpeg-macos-x86_64
            ffmpeg_root: aero_music_separator/native/third_party/ffmpeg/macos/x86_64
          - id: macos-metal-arm64
            os: macos-14
            backend: metal
            ggml_cuda: 'OFF'
            ggml_vulkan: 'OFF'
            ggml_metal: 'ON'
            ffmpeg_artifact: ffmpeg-macos-arm64
            ffmpeg_root: aero_music_separator/native/third_party/ffmpeg/macos/arm64

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Download ffmpeg artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.ffmpeg_artifact }}
          path: ${{ matrix.ffmpeg_root }}

      - name: Install deps (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build pkg-config python3 ffmpeg libvulkan-dev
          sudo apt-get install -y glslc || sudo apt-get install -y glslang-tools

      - name: Install deps (macOS)
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install cmake ninja pkg-config ffmpeg sccache libomp

      - name: Install deps (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: choco install ninja ffmpeg -y

      - name: Install Vulkan SDK (Windows Vulkan backend)
        if: runner.os == 'Windows' && matrix.backend == 'vulkan'
        shell: pwsh
        run: |
          $VK_VERSION = "1.4.313.2"
          curl.exe -o VulkanSDK.exe -L "https://sdk.lunarg.com/sdk/download/${VK_VERSION}/windows/vulkansdk-windows-X64-${VK_VERSION}.exe"
          Start-Process -FilePath .\VulkanSDK.exe -ArgumentList "--accept-licenses --default-answer --confirm-command install" -Wait
          Add-Content $env:GITHUB_ENV "VULKAN_SDK=C:\VulkanSDK\${VK_VERSION}"
          Add-Content $env:GITHUB_PATH "C:\VulkanSDK\${VK_VERSION}\bin"

      - name: Setup MSVC
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Resolve build jobs (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          if [ -z "${BUILD_JOBS_INPUT}" ] || [ "${BUILD_JOBS_INPUT}" = "auto" ]; then
            jobs="$(nproc 2>/dev/null || sysctl -n hw.logicalcpu)"
          else
            jobs="${BUILD_JOBS_INPUT}"
          fi
          echo "BUILD_JOBS=${jobs}" >> "$GITHUB_ENV"

      - name: Resolve build jobs (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          if ([string]::IsNullOrWhiteSpace($env:BUILD_JOBS_INPUT) -or $env:BUILD_JOBS_INPUT -eq 'auto') {
            $jobs = $env:NUMBER_OF_PROCESSORS
          } else {
            $jobs = $env:BUILD_JOBS_INPUT
          }
          Add-Content $env:GITHUB_ENV "BUILD_JOBS=$jobs"

      - name: Configure native (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          mkdir -p build
          cmake -S aero_music_separator/native -B build/native -G Ninja \
            -DAMS_BSR_ROOT="${GITHUB_WORKSPACE}/BSRoformer.cpp" \
            -DGGML_DIR="${GITHUB_WORKSPACE}/ggml" \
            -DAMS_USE_SYSTEM_FFMPEG=OFF \
            -DAMS_FFMPEG_ROOT="${GITHUB_WORKSPACE}/${{ matrix.ffmpeg_root }}" \
            -DGGML_CUDA=${{ matrix.ggml_cuda }} \
            -DGGML_VULKAN=${{ matrix.ggml_vulkan }} \
            -DGGML_METAL=${{ matrix.ggml_metal }} \
            -DCMAKE_C_COMPILER_LAUNCHER=sccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=sccache \
            2>&1 | tee build/openmp-configure.log
          grep -E "OpenMP:" build/openmp-configure.log || true

      - name: Configure native (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path build | Out-Null
          cmake -S aero_music_separator/native -B build/native -G "Ninja Multi-Config" `
            -DAMS_BSR_ROOT="${env:GITHUB_WORKSPACE}/BSRoformer.cpp" `
            -DGGML_DIR="${env:GITHUB_WORKSPACE}/ggml" `
            -DAMS_USE_SYSTEM_FFMPEG=OFF `
            -DAMS_FFMPEG_ROOT="${env:GITHUB_WORKSPACE}/${{ matrix.ffmpeg_root }}" `
            -DGGML_CUDA=${{ matrix.ggml_cuda }} `
            -DGGML_VULKAN=${{ matrix.ggml_vulkan }} `
            -DGGML_METAL=${{ matrix.ggml_metal }} `
            -DCMAKE_C_COMPILER_LAUNCHER=sccache `
            -DCMAKE_CXX_COMPILER_LAUNCHER=sccache `
            2>&1 | Tee-Object -FilePath build/openmp-configure.log
          Select-String -Path build/openmp-configure.log -Pattern "OpenMP:" -CaseSensitive:$false

      - name: Build native (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: cmake --build build/native --parallel "${BUILD_JOBS}"

      - name: Build native (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: cmake --build build/native --config Release --parallel $env:BUILD_JOBS

      - name: Smoke test prepare flow (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          lib_path="$(find build/native -type f \( -name 'libaero_separator_ffi.so' -o -name 'libaero_separator_ffi.dylib' \) | head -n1)"
          if [ -z "$lib_path" ]; then
            echo "aero_separator_ffi library not found"
            exit 1
          fi
          python3 aero_music_separator/native/tools/ffi_prepare_smoke.py \
            --library "$lib_path" \
            --verify-ogg-opus \
            --verify-wav-variants

      - name: Smoke test prepare flow (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $lib = Get-ChildItem build/native -Recurse -Filter aero_separator_ffi.dll | Select-Object -First 1
          if (-not $lib) {
            throw "aero_separator_ffi.dll not found"
          }
          python aero_music_separator/native/tools/ffi_prepare_smoke.py `
            --library $lib.FullName `
            --verify-ogg-opus `
            --verify-wav-variants

      - name: sccache stats (Unix)
        if: runner.os != 'Windows'
        run: sccache --show-stats || true

      - name: sccache stats (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: sccache --show-stats

      - name: Upload OpenMP logs and native artifacts
        uses: actions/upload-artifact@v4
        with:
          name: native-openmp-${{ matrix.id }}
          path: |
            build/openmp-configure.log
            build/native/**/*.dll
            build/native/**/*.so
            build/native/**/*.dylib
          if-no-files-found: warn
          retention-days: 7

  build-app:
    name: app-${{ matrix.id }}
    needs: prepare-ffmpeg
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - id: android-release
            os: ubuntu-24.04
            platform: android
            artifact_name: app-android-release
            artifact_path: aero_music_separator/android/app/build/outputs/**
          - id: linux-release
            os: ubuntu-24.04
            platform: linux
            artifact_name: app-linux-release
            artifact_path: aero_music_separator/build/linux/x64/release/bundle/**
          - id: windows-release
            os: windows-2025
            platform: windows
            artifact_name: app-windows-release
            artifact_path: aero_music_separator/build/windows/x64/runner/Release/**
          - id: macos-release-x86_64
            os: macos-13
            platform: macos
            ffmpeg_artifact: ffmpeg-macos-x86_64
            ffmpeg_root: aero_music_separator/native/third_party/ffmpeg/macos/x86_64
            artifact_name: app-macos-release-x86_64
            artifact_path: aero_music_separator/build/macos/Build/Products/Release/*.app
          - id: macos-release-arm64
            os: macos-14
            platform: macos
            ffmpeg_artifact: ffmpeg-macos-arm64
            ffmpeg_root: aero_music_separator/native/third_party/ffmpeg/macos/arm64
            artifact_name: app-macos-release-arm64
            artifact_path: aero_music_separator/build/macos/Build/Products/Release/*.app
          - id: ios-release
            os: macos-14
            platform: ios
            ffmpeg_artifact: ffmpeg-ios-device-sim-arm64
            ffmpeg_root: aero_music_separator/native/third_party/ffmpeg/ios
            artifact_name: app-ios-release
            artifact_path: aero_music_separator/build/ios/iphoneos/*.app

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Setup Java (Android)
        if: matrix.platform == 'android'
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup Android SDK
        if: matrix.platform == 'android'
        uses: android-actions/setup-android@v3

      - name: Install Android NDK/CMake
        if: matrix.platform == 'android'
        run: sdkmanager "ndk;27.2.12479018" "cmake;3.22.1"

      - name: Install Linux build deps
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang \
            cmake \
            ninja-build \
            pkg-config \
            libgtk-3-dev \
            liblzma-dev \
            libstdc++-12-dev \
            libavformat-dev \
            libavcodec-dev \
            libavutil-dev \
            libswresample-dev

      - name: Install macOS build deps
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install cmake ninja pkg-config libomp cocoapods

      - name: Install Windows build deps
        if: runner.os == 'Windows'
        shell: pwsh
        run: choco install ninja -y

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Resolve build jobs (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          if [ -z "${BUILD_JOBS_INPUT}" ] || [ "${BUILD_JOBS_INPUT}" = "auto" ]; then
            jobs="$(nproc 2>/dev/null || sysctl -n hw.logicalcpu)"
          else
            jobs="${BUILD_JOBS_INPUT}"
          fi
          echo "BUILD_JOBS=${jobs}" >> "$GITHUB_ENV"

      - name: Resolve build jobs (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          if ([string]::IsNullOrWhiteSpace($env:BUILD_JOBS_INPUT) -or $env:BUILD_JOBS_INPUT -eq 'auto') {
            $jobs = $env:NUMBER_OF_PROCESSORS
          } else {
            $jobs = $env:BUILD_JOBS_INPUT
          }
          Add-Content $env:GITHUB_ENV "BUILD_JOBS=$jobs"

      - name: Download ffmpeg (Linux)
        if: matrix.platform == 'linux'
        uses: actions/download-artifact@v4
        with:
          name: ffmpeg-linux-x86_64
          path: aero_music_separator/native/third_party/ffmpeg/linux/x86_64

      - name: Download ffmpeg (Windows)
        if: matrix.platform == 'windows'
        uses: actions/download-artifact@v4
        with:
          name: ffmpeg-windows-x64
          path: aero_music_separator/native/third_party/ffmpeg/windows/x64

      - name: Download ffmpeg (macOS)
        if: matrix.platform == 'macos'
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.ffmpeg_artifact }}
          path: ${{ matrix.ffmpeg_root }}

      - name: Download ffmpeg (iOS)
        if: matrix.platform == 'ios'
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.ffmpeg_artifact }}
          path: ${{ matrix.ffmpeg_root }}

      - name: Download ffmpeg (Android arm64-v8a)
        if: matrix.platform == 'android'
        uses: actions/download-artifact@v4
        with:
          name: ffmpeg-android-arm64-v8a
          path: aero_music_separator/native/third_party/ffmpeg/android/arm64-v8a

      - name: Download ffmpeg (Android armeabi-v7a)
        if: matrix.platform == 'android'
        uses: actions/download-artifact@v4
        with:
          name: ffmpeg-android-armeabi-v7a
          path: aero_music_separator/native/third_party/ffmpeg/android/armeabi-v7a

      - name: Download ffmpeg (Android x86_64)
        if: matrix.platform == 'android'
        uses: actions/download-artifact@v4
        with:
          name: ffmpeg-android-x86_64
          path: aero_music_separator/native/third_party/ffmpeg/android/x86_64

      - name: Flutter pub get
        working-directory: aero_music_separator
        run: flutter pub get

      - name: Build Android app
        if: matrix.platform == 'android'
        working-directory: aero_music_separator/android
        env:
          ANDROID_NDK_HOME: /usr/local/lib/android/sdk/ndk/27.2.12479018
        run: |
          chmod +x ./gradlew
          ./gradlew :app:assembleRelease --stacktrace --parallel --max-workers=${BUILD_JOBS}

      - name: Build Linux app
        if: matrix.platform == 'linux'
        working-directory: aero_music_separator
        run: flutter build linux --release

      - name: Build Windows app
        if: matrix.platform == 'windows'
        working-directory: aero_music_separator
        run: flutter build windows --release

      - name: Build macOS app
        if: matrix.platform == 'macos'
        working-directory: aero_music_separator
        run: flutter build macos --release

      - name: Smoke check macOS runtime bundle
        if: matrix.platform == 'macos'
        shell: bash
        run: |
          app_path="$(find aero_music_separator/build/macos/Build/Products/Release -maxdepth 1 -name '*.app' | head -n1)"
          if [ -z "${app_path}" ]; then
            echo "macOS app artifact not found"
            exit 1
          fi
          ffi_lib="${app_path}/Contents/Frameworks/libaero_separator_ffi.dylib"
          if [ ! -f "${ffi_lib}" ]; then
            echo "macOS FFI dylib missing in app bundle"
            exit 1
          fi
          otool -L "${ffi_lib}"

      - name: Build iOS app
        if: matrix.platform == 'ios'
        working-directory: aero_music_separator
        run: flutter build ios --release --no-codesign

      - name: Smoke check iOS native packaging
        if: matrix.platform == 'ios'
        shell: bash
        run: |
          if [ ! -d "aero_music_separator/native/ios/AeroSeparatorFFI/AeroSeparatorFFI.xcframework" ]; then
            echo "iOS XCFramework was not generated"
            exit 1
          fi
          if [ ! -d "aero_music_separator/build/ios/iphoneos/Runner.app" ]; then
            echo "iOS Runner.app not found after build"
            exit 1
          fi

      - name: sccache stats (Unix)
        if: runner.os != 'Windows'
        run: sccache --show-stats || true

      - name: sccache stats (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: sccache --show-stats

      - name: Upload app artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ matrix.artifact_path }}
          if-no-files-found: error
          retention-days: 7

  compliance-bundle:
    name: compliance-bundle
    needs: prepare-ffmpeg
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Download ffmpeg artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: ffmpeg-*
          path: aero_music_separator/native/third_party/ffmpeg
          merge-multiple: false

      - name: Generate compliance bundle
        shell: bash
        run: |
          python3 aero_music_separator/native/tools/compliance/generate_bundle.py \
            --repo-root "${GITHUB_WORKSPACE}" \
            --out "${GITHUB_WORKSPACE}/compliance-bundle" \
            --strict

      - name: Upload compliance bundle
        uses: actions/upload-artifact@v4
        with:
          name: compliance-bundle
          path: compliance-bundle/**
          if-no-files-found: error
          retention-days: 30

  build-native-cuda:
    name: native-cuda-${{ matrix.id }}
    needs: prepare-ffmpeg
    if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.run_cuda == 'true' }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - id: linux-cuda-11_8
            os: ubuntu-22.04
            platform: linux
            cuda_version: '11.8.0'
            ffmpeg_artifact: ffmpeg-linux-x86_64
            ffmpeg_root: aero_music_separator/native/third_party/ffmpeg/linux/x86_64
          - id: linux-cuda-12_9
            os: ubuntu-latest
            platform: linux
            cuda_version: '12.9.1'
            ffmpeg_artifact: ffmpeg-linux-x86_64
            ffmpeg_root: aero_music_separator/native/third_party/ffmpeg/linux/x86_64
          - id: linux-cuda-13_1
            os: ubuntu-latest
            platform: linux
            cuda_version: '13.1.0'
            ffmpeg_artifact: ffmpeg-linux-x86_64
            ffmpeg_root: aero_music_separator/native/third_party/ffmpeg/linux/x86_64
          - id: windows-cuda-11_8
            os: windows-2025
            platform: windows
            cuda_version: '11.8.0'
            ffmpeg_artifact: ffmpeg-windows-x64
            ffmpeg_root: aero_music_separator/native/third_party/ffmpeg/windows/x64
          - id: windows-cuda-12_9
            os: windows-2025
            platform: windows
            cuda_version: '12.9.1'
            ffmpeg_artifact: ffmpeg-windows-x64
            ffmpeg_root: aero_music_separator/native/third_party/ffmpeg/windows/x64
          - id: windows-cuda-13_1
            os: windows-2025
            platform: windows
            cuda_version: '13.1.0'
            ffmpeg_artifact: ffmpeg-windows-x64
            ffmpeg_root: aero_music_separator/native/third_party/ffmpeg/windows/x64

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Download ffmpeg artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.ffmpeg_artifact }}
          path: ${{ matrix.ffmpeg_root }}

      - name: Install deps (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build build-essential pkg-config python3

      - name: Install deps (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: choco install ninja ffmpeg -y

      - name: Setup MSVC
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Resolve build jobs (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          if [ -z "${BUILD_JOBS_INPUT}" ] || [ "${BUILD_JOBS_INPUT}" = "auto" ]; then
            jobs="$(nproc 2>/dev/null || sysctl -n hw.logicalcpu)"
          else
            jobs="${BUILD_JOBS_INPUT}"
          fi
          echo "BUILD_JOBS=${jobs}" >> "$GITHUB_ENV"

      - name: Resolve build jobs (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          if ([string]::IsNullOrWhiteSpace($env:BUILD_JOBS_INPUT) -or $env:BUILD_JOBS_INPUT -eq 'auto') {
            $jobs = $env:NUMBER_OF_PROCESSORS
          } else {
            $jobs = $env:BUILD_JOBS_INPUT
          }
          Add-Content $env:GITHUB_ENV "BUILD_JOBS=$jobs"

      - name: Install CUDA Toolkit (Linux)
        if: runner.os == 'Linux'
        uses: Jimver/cuda-toolkit@master
        with:
          cuda: ${{ matrix.cuda_version }}
          method: network
          sub-packages: '["nvcc", "cudart", "thrust"]'
          non-cuda-sub-packages: '["libcublas", "libcublas-dev"]'

      - name: Install CUDA Toolkit (Windows)
        if: runner.os == 'Windows' && matrix.cuda_version != '13.1.0'
        uses: Jimver/cuda-toolkit@master
        with:
          cuda: ${{ matrix.cuda_version }}
          method: network
          sub-packages: '["nvcc", "cudart", "cublas", "cublas_dev", "thrust", "visual_studio_integration"]'

      - name: Install CUDA Toolkit (Windows 13.1.0)
        if: runner.os == 'Windows' && matrix.cuda_version == '13.1.0'
        uses: Jimver/cuda-toolkit@master
        with:
          cuda: ${{ matrix.cuda_version }}
          method: network
          sub-packages: '["nvcc", "cudart", "cublas", "cublas_dev", "nvrtc", "nvrtc_dev", "crt", "nvvm", "visual_studio_integration"]'

      - name: Configure native CUDA (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          # Keep compile verification fast and aligned with BSR workflow CUDA strategy.
          CUDA_ARCHS="75;86"
          cmake -S aero_music_separator/native -B build/native -G Ninja \
            -DAMS_BSR_ROOT="${GITHUB_WORKSPACE}/BSRoformer.cpp" \
            -DGGML_DIR="${GITHUB_WORKSPACE}/ggml" \
            -DAMS_USE_SYSTEM_FFMPEG=OFF \
            -DAMS_FFMPEG_ROOT="${GITHUB_WORKSPACE}/${{ matrix.ffmpeg_root }}" \
            -DGGML_CUDA=ON \
            -DGGML_CUDA_FORCE_MMQ=ON \
            -DGGML_VULKAN=OFF \
            -DGGML_METAL=OFF \
            -DCMAKE_CUDA_ARCHITECTURES="${CUDA_ARCHS}" \
            -DCMAKE_C_COMPILER_LAUNCHER=sccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=sccache \
            -DCMAKE_CUDA_COMPILER_LAUNCHER=sccache

      - name: Configure native CUDA (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $cudaVersion = "${{ matrix.cuda_version }}"
          if ($cudaVersion -match "^11\.") {
            $cudaArchs = "61;75;86;89"
            $env:CUDAFLAGS = "-allow-unsupported-compiler -D_ALLOW_COMPILER_AND_STL_VERSION_MISMATCH -D_DISABLE_CONSTEXPR_MUTEX_CONSTRUCTOR"
          } elseif ($cudaVersion -match "^12\.") {
            $cudaArchs = "61;75;86;89"
            $env:CUDAFLAGS = ""
          } else {
            $cudaArchs = "75;86;89;120"
            $env:CUDAFLAGS = ""
          }

          cmake -S aero_music_separator/native -B build/native -G "Ninja Multi-Config" `
            -DAMS_BSR_ROOT="${env:GITHUB_WORKSPACE}/BSRoformer.cpp" `
            -DGGML_DIR="${env:GITHUB_WORKSPACE}/ggml" `
            -DAMS_USE_SYSTEM_FFMPEG=OFF `
            -DAMS_FFMPEG_ROOT="${env:GITHUB_WORKSPACE}/${{ matrix.ffmpeg_root }}" `
            -DGGML_CUDA=ON `
            -DGGML_CUDA_FORCE_MMQ=ON `
            -DGGML_VULKAN=OFF `
            -DGGML_METAL=OFF `
            "-DCMAKE_CUDA_ARCHITECTURES=$cudaArchs" `
            -DCMAKE_C_COMPILER_LAUNCHER=sccache `
            -DCMAKE_CXX_COMPILER_LAUNCHER=sccache

      - name: Build native CUDA (Linux)
        if: runner.os == 'Linux'
        run: cmake --build build/native --parallel "${BUILD_JOBS}"

      - name: Build native CUDA (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: cmake --build build/native --config Release --parallel $env:BUILD_JOBS

      - name: sccache stats (Unix)
        if: runner.os != 'Windows'
        run: sccache --show-stats || true

      - name: sccache stats (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: sccache --show-stats

      - name: Upload CUDA artifacts
        uses: actions/upload-artifact@v4
        with:
          name: native-cuda-${{ matrix.id }}
          path: |
            build/native/**/*.dll
            build/native/**/*.so
            build/native/**/*.dylib
            build/native/**/*.a
          if-no-files-found: warn
          retention-days: 7
