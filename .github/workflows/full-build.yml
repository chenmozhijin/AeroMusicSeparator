name: Full Build CI

on:
  pull_request:
  push:
    branches: [main, master]
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      build_jobs:
        description: Parallel build jobs (auto or integer)
        required: false
        default: auto
        type: string

concurrency:
  group: full-build-${{ github.ref }}
  cancel-in-progress: true

env:
  AMS_FFMPEG_VERSION: n8.0
  AMS_LAME_VERSION: '3.100'
  BUILD_JOBS_INPUT: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.build_jobs || 'auto' }}

jobs:
  prepare-ffmpeg:
    name: ffmpeg-${{ matrix.id }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - id: linux-x86_64
            os: ubuntu-24.04
            platform: linux
            artifact_name: ffmpeg-linux-x86_64
            artifact_path: aero_music_separator/native/third_party/ffmpeg/linux/x86_64
            run_cmd: ./aero_music_separator/native/tools/ffmpeg/build_linux.sh x86_64
          - id: windows-x64
            os: windows-2025
            platform: windows
            artifact_name: ffmpeg-windows-x64
            artifact_path: aero_music_separator/native/third_party/ffmpeg/windows/x64
            run_cmd: .\aero_music_separator\native\tools\ffmpeg\build_windows.ps1 -Arch x64
          - id: macos-x86_64
            os: macos-15-intel
            platform: macos
            artifact_name: ffmpeg-macos-x86_64
            artifact_path: aero_music_separator/native/third_party/ffmpeg/macos/x86_64
            run_cmd: ./aero_music_separator/native/tools/ffmpeg/build_macos.sh x86_64
          - id: macos-arm64
            os: macos-14
            platform: macos
            artifact_name: ffmpeg-macos-arm64
            artifact_path: aero_music_separator/native/third_party/ffmpeg/macos/arm64
            run_cmd: ./aero_music_separator/native/tools/ffmpeg/build_macos.sh arm64
          - id: ios-device-sim-arm64
            os: macos-14
            platform: ios
            artifact_name: ffmpeg-ios-device-sim-arm64
            artifact_path: aero_music_separator/native/third_party/ffmpeg/ios
            run_cmd: ./aero_music_separator/native/tools/ffmpeg/build_ios.sh arm64
          - id: android-arm64-v8a
            os: ubuntu-24.04
            platform: android
            artifact_name: ffmpeg-android-arm64-v8a
            artifact_path: aero_music_separator/native/third_party/ffmpeg/android/arm64-v8a
            run_cmd: ./aero_music_separator/native/tools/ffmpeg/build_android.sh arm64-v8a
          - id: android-x86_64
            os: ubuntu-24.04
            platform: android
            artifact_name: ffmpeg-android-x86_64
            artifact_path: aero_music_separator/native/third_party/ffmpeg/android/x86_64
            run_cmd: ./aero_music_separator/native/tools/ffmpeg/build_android.sh x86_64

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Linux deps
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            autoconf \
            automake \
            libtool \
            pkg-config \
            make \
            nasm \
            yasm \
            python3 \
            cmake \
            ninja-build \
            curl \
            git

      - name: Install macOS deps
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install autoconf automake libtool pkg-config nasm yasm sccache

      - name: Setup MSYS2 (Windows)
        if: runner.os == 'Windows'
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            base-devel
            make
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-autotools
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-make
            mingw-w64-x86_64-nasm
            mingw-w64-x86_64-yasm
            mingw-w64-x86_64-pkgconf
            mingw-w64-x86_64-python

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Cache ffmpeg sources/build
        uses: actions/cache@v4
        with:
          path: |
            .cache/ffmpeg-src
            .cache/ffmpeg-build
            ~/.cache/sccache
            ~/Library/Caches/Mozilla.sccache
            ~\AppData\Local\Mozilla\sccache
          key: ffmpeg-${{ matrix.id }}-${{ env.AMS_FFMPEG_VERSION }}-${{ env.AMS_LAME_VERSION }}-${{ hashFiles('aero_music_separator/native/tools/ffmpeg/**') }}

      - name: Setup Android SDK
        if: matrix.platform == 'android'
        uses: android-actions/setup-android@v3

      - name: Install Android NDK
        if: matrix.platform == 'android'
        run: sdkmanager "ndk;27.2.12479018"

      - name: Build ffmpeg (Unix)
        if: runner.os != 'Windows'
        shell: bash
        env:
          ANDROID_NDK_HOME: /usr/local/lib/android/sdk/ndk/27.2.12479018
          AMS_USE_SCCACHE: 'ON'
        run: |
          chmod +x aero_music_separator/native/tools/ffmpeg/*.sh
          ${{ matrix.run_cmd }}

      - name: Build ffmpeg (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: ${{ matrix.run_cmd }}

      - name: Assert FFmpeg bundles include libmp3lame.a
        if: matrix.platform == 'android' || matrix.platform == 'ios'
        shell: bash
        run: |
          set -euo pipefail
          echo "Inspecting staged FFmpeg bundle: ${{ matrix.artifact_path }}"
          find "${{ matrix.artifact_path }}" -type f -name 'libmp3lame.a' -print || true
          if [[ "${{ matrix.platform }}" == "android" ]]; then
            test -f "${{ matrix.artifact_path }}/lib/libmp3lame.a"
          else
            test -f "${{ matrix.artifact_path }}/iphoneos-arm64/lib/libmp3lame.a"
            test -f "${{ matrix.artifact_path }}/iphonesimulator-arm64/lib/libmp3lame.a"
          fi

      - name: sccache stats (Unix)
        if: runner.os != 'Windows'
        run: sccache --show-stats || true

      - name: sccache stats (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: sccache --show-stats

      - name: Verify ffmpeg manifest license profile (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          python3 aero_music_separator/native/tools/ffmpeg/verify_manifest_license.py \
            --manifest "${{ matrix.artifact_path }}/manifest.json"

      - name: Verify ffmpeg manifest license profile (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          python aero_music_separator/native/tools/ffmpeg/verify_manifest_license.py `
            --manifest "${{ matrix.artifact_path }}/manifest.json"

      - name: Upload ffmpeg artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ matrix.artifact_path }}
          if-no-files-found: error
          retention-days: 7

  build-app:
    name: app-${{ matrix.id }}
    needs: prepare-ffmpeg
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - id: android-vulkan-release
            os: ubuntu-24.04
            platform: android
            backend: vulkan
            artifact_name: app-android-vulkan-release
            artifact_path: aero_music_separator/build/app/outputs/**
          - id: linux-vulkan-release
            os: ubuntu-24.04
            platform: linux
            backend: vulkan
            artifact_name: app-linux-vulkan-release
            artifact_path: aero_music_separator/build/linux/x64/release/bundle/**
          - id: linux-cuda-11_8-release
            os: ubuntu-22.04
            platform: linux
            backend: cuda
            cuda_version: '11.8.0'
            cuda_architectures: '61;75;86;89'
            artifact_name: app-linux-cuda-11_8-release
            artifact_path: aero_music_separator/build/linux/x64/release/bundle/**
          - id: linux-cuda-12_9-release
            os: ubuntu-24.04
            platform: linux
            backend: cuda
            cuda_version: '12.9.1'
            cuda_architectures: '61;75;86;89'
            artifact_name: app-linux-cuda-12_9-release
            artifact_path: aero_music_separator/build/linux/x64/release/bundle/**
          - id: linux-cuda-13_1-release
            os: ubuntu-24.04
            platform: linux
            backend: cuda
            cuda_version: '13.1.0'
            cuda_architectures: '75;86;89;120'
            artifact_name: app-linux-cuda-13_1-release
            artifact_path: aero_music_separator/build/linux/x64/release/bundle/**
          - id: windows-vulkan-release
            os: windows-2025
            platform: windows
            backend: vulkan
            artifact_name: app-windows-vulkan-release
            artifact_path: aero_music_separator/build/windows/x64/runner/Release/**
          - id: windows-cuda-11_8-release
            os: windows-2022
            platform: windows
            backend: cuda
            cuda_version: '11.8.0'
            cuda_architectures: '61;75;86;89'
            cuda_flags: "-allow-unsupported-compiler -D_ALLOW_COMPILER_AND_STL_VERSION_MISMATCH -D_DISABLE_CONSTEXPR_MUTEX_CONSTRUCTOR"
            cl_flags: "/D_ALLOW_COMPILER_AND_STL_VERSION_MISMATCH /D_DISABLE_CONSTEXPR_MUTEX_CONSTRUCTOR"
            artifact_name: app-windows-cuda-11_8-release
            artifact_path: aero_music_separator/build/windows/x64/runner/Release/**
          - id: windows-cuda-12_9-release
            os: windows-2025
            platform: windows
            backend: cuda
            cuda_version: '12.9.1'
            cuda_architectures: '61;75;86;89'
            artifact_name: app-windows-cuda-12_9-release
            artifact_path: aero_music_separator/build/windows/x64/runner/Release/**
          - id: windows-cuda-13_1-release
            os: windows-2025
            platform: windows
            backend: cuda
            cuda_version: '13.1.0'
            cuda_architectures: '75;86;89;120'
            artifact_name: app-windows-cuda-13_1-release
            artifact_path: aero_music_separator/build/windows/x64/runner/Release/**
          - id: macos-metal-x86_64-release
            os: macos-15-intel
            platform: macos
            backend: metal
            ffmpeg_artifact: ffmpeg-macos-x86_64
            ffmpeg_root: aero_music_separator/native/third_party/ffmpeg/macos/x86_64
            artifact_name: app-macos-metal-x86_64-release
            artifact_path: aero_music_separator/build/macos/Build/Products/Release/*.app
          - id: macos-metal-arm64-release
            os: macos-14
            platform: macos
            backend: metal
            ffmpeg_artifact: ffmpeg-macos-arm64
            ffmpeg_root: aero_music_separator/native/third_party/ffmpeg/macos/arm64
            artifact_name: app-macos-metal-arm64-release
            artifact_path: aero_music_separator/build/macos/Build/Products/Release/*.app
          - id: ios-metal-release
            os: macos-14
            platform: ios
            backend: metal
            ffmpeg_artifact: ffmpeg-ios-device-sim-arm64
            ffmpeg_root: aero_music_separator/native/third_party/ffmpeg/ios
            artifact_name: app-ios-metal-release
            artifact_path: aero_music_separator/build/ios/iphoneos/*.app

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Setup Java (Android)
        if: matrix.platform == 'android'
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup Android SDK
        if: matrix.platform == 'android'
        uses: android-actions/setup-android@v3

      - name: Install Android NDK/CMake
        if: matrix.platform == 'android'
        run: sdkmanager "ndk;28.2.13676358" "cmake;3.22.1"

      - name: Install Linux build deps
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc \
            g++ \
            clang \
            cmake \
            ninja-build \
            pkg-config \
            libgtk-3-dev \
            liblzma-dev \
            libstdc++-12-dev \
            libomp-dev \
            libgomp1 \
            ffmpeg
          if [ "${{ matrix.backend }}" = "vulkan" ]; then
            sudo apt-get install -y libvulkan-dev
            sudo apt-get install -y glslc || sudo apt-get install -y glslang-tools
          fi

      - name: Install macOS build deps
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install cmake ninja pkg-config libomp ffmpeg
          if ! command -v pod >/dev/null 2>&1; then
            brew install cocoapods
          fi

      - name: Install Windows build deps
        if: runner.os == 'Windows'
        shell: pwsh
        run: choco install ninja ffmpeg -y

      - name: Install Vulkan SDK (Windows Vulkan backend)
        if: runner.os == 'Windows' && matrix.backend == 'vulkan'
        shell: pwsh
        run: |
          $VK_VERSION = "1.4.313.2"
          curl.exe -o VulkanSDK.exe -L "https://sdk.lunarg.com/sdk/download/${VK_VERSION}/windows/vulkansdk-windows-X64-${VK_VERSION}.exe"
          Start-Process -FilePath .\VulkanSDK.exe -ArgumentList "--accept-licenses --default-answer --confirm-command install" -Wait
          Add-Content $env:GITHUB_ENV "VULKAN_SDK=C:\VulkanSDK\${VK_VERSION}"
          Add-Content $env:GITHUB_PATH "C:\VulkanSDK\${VK_VERSION}\bin"

      - name: Setup MSVC
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Resolve build jobs (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          if [ -z "${BUILD_JOBS_INPUT}" ] || [ "${BUILD_JOBS_INPUT}" = "auto" ]; then
            jobs="$(nproc 2>/dev/null || sysctl -n hw.logicalcpu)"
          else
            jobs="${BUILD_JOBS_INPUT}"
          fi
          echo "BUILD_JOBS=${jobs}" >> "$GITHUB_ENV"

      - name: Resolve build jobs (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          if ([string]::IsNullOrWhiteSpace($env:BUILD_JOBS_INPUT) -or $env:BUILD_JOBS_INPUT -eq 'auto') {
            $jobs = $env:NUMBER_OF_PROCESSORS
          } else {
            $jobs = $env:BUILD_JOBS_INPUT
          }
          Add-Content $env:GITHUB_ENV "BUILD_JOBS=$jobs"

      - name: Download ffmpeg (Linux)
        if: matrix.platform == 'linux'
        uses: actions/download-artifact@v4
        with:
          name: ffmpeg-linux-x86_64
          path: aero_music_separator/native/third_party/ffmpeg/linux/x86_64

      - name: Download ffmpeg (Windows)
        if: matrix.platform == 'windows'
        uses: actions/download-artifact@v4
        with:
          name: ffmpeg-windows-x64
          path: aero_music_separator/native/third_party/ffmpeg/windows/x64

      - name: Download ffmpeg (macOS)
        if: matrix.platform == 'macos'
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.ffmpeg_artifact }}
          path: ${{ matrix.ffmpeg_root }}

      - name: Download ffmpeg (iOS)
        if: matrix.platform == 'ios'
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.ffmpeg_artifact }}
          path: ${{ matrix.ffmpeg_root }}

      - name: Download ffmpeg (Android arm64-v8a)
        if: matrix.platform == 'android'
        uses: actions/download-artifact@v4
        with:
          name: ffmpeg-android-arm64-v8a
          path: aero_music_separator/native/third_party/ffmpeg/android/arm64-v8a

      - name: Download ffmpeg (Android x86_64)
        if: matrix.platform == 'android'
        uses: actions/download-artifact@v4
        with:
          name: ffmpeg-android-x86_64
          path: aero_music_separator/native/third_party/ffmpeg/android/x86_64

      - name: Assert downloaded FFmpeg bundles include libmp3lame.a (Android)
        if: matrix.platform == 'android'
        shell: bash
        run: |
          set -euo pipefail
          find aero_music_separator/native/third_party/ffmpeg/android -type f -name 'libmp3lame.a' -print || true
          test -f aero_music_separator/native/third_party/ffmpeg/android/arm64-v8a/lib/libmp3lame.a
          test -f aero_music_separator/native/third_party/ffmpeg/android/x86_64/lib/libmp3lame.a

      - name: Assert downloaded FFmpeg bundles include libmp3lame.a (iOS)
        if: matrix.platform == 'ios'
        shell: bash
        run: |
          set -euo pipefail
          find aero_music_separator/native/third_party/ffmpeg/ios -type f -name 'libmp3lame.a' -print || true
          test -f aero_music_separator/native/third_party/ffmpeg/ios/iphoneos-arm64/lib/libmp3lame.a
          test -f aero_music_separator/native/third_party/ffmpeg/ios/iphonesimulator-arm64/lib/libmp3lame.a

      - name: Install CUDA Toolkit (Linux)
        if: runner.os == 'Linux' && matrix.backend == 'cuda'
        uses: Jimver/cuda-toolkit@master
        with:
          cuda: ${{ matrix.cuda_version }}
          method: network
          sub-packages: '["nvcc", "cudart", "thrust"]'
          non-cuda-sub-packages: '["libcublas", "libcublas-dev"]'

      - name: Install CUDA Toolkit (Windows)
        if: runner.os == 'Windows' && matrix.backend == 'cuda' && matrix.cuda_version != '13.1.0'
        uses: Jimver/cuda-toolkit@master
        with:
          cuda: ${{ matrix.cuda_version }}
          method: network
          sub-packages: '["nvcc", "cudart", "cublas", "cublas_dev", "thrust", "visual_studio_integration"]'

      - name: Install CUDA Toolkit (Windows 13.1.0)
        if: runner.os == 'Windows' && matrix.backend == 'cuda' && matrix.cuda_version == '13.1.0'
        uses: Jimver/cuda-toolkit@master
        with:
          cuda: ${{ matrix.cuda_version }}
          method: network
          sub-packages: '["nvcc", "cudart", "cublas", "cublas_dev", "nvrtc", "nvrtc_dev", "crt", "nvvm", "visual_studio_integration"]'

      - name: Flutter pub get
        working-directory: aero_music_separator
        run: flutter pub get

      - name: Generate Android release tooling
        if: matrix.platform == 'android'
        working-directory: aero_music_separator
        run: flutter build apk --config-only --release

      - name: Verify Android release plugin registrant
        if: matrix.platform == 'android'
        working-directory: aero_music_separator
        shell: bash
        run: |
          set -euo pipefail
          registrant="android/app/src/main/java/io/flutter/plugins/GeneratedPluginRegistrant.java"
          if grep -q "integration_test\\.IntegrationTestPlugin" "${registrant}"; then
            echo "::error file=${registrant}::integration_test plugin is still present in release GeneratedPluginRegistrant.java after --config-only --release."
            echo "This would fail :app:compileReleaseJavaWithJavac because integration_test is a dev dependency."
            exit 1
          fi

      - name: Map short workspace drive (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          if (subst | Select-String '^W:') {
            subst W: /D
          }
          subst W: $env:GITHUB_WORKSPACE
          if (-not (Test-Path "W:\aero_music_separator")) {
            throw "Failed to map workspace to W:"
          }

      - name: Build Android app
        if: matrix.platform == 'android'
        working-directory: aero_music_separator/android
        env:
          ANDROID_NDK_HOME: /usr/local/lib/android/sdk/ndk/28.2.13676358
          AMS_NATIVE_BACKEND: ${{ matrix.backend }}
          CMAKE_BUILD_PARALLEL_LEVEL: ${{ env.BUILD_JOBS }}
        run: |
          chmod +x ./gradlew
          ./gradlew :app:assembleRelease --stacktrace --parallel --max-workers=${BUILD_JOBS}

      - name: Build Linux app
        if: matrix.platform == 'linux'
        working-directory: aero_music_separator
        env:
          AMS_NATIVE_BACKEND: ${{ matrix.backend }}
          AMS_CUDA_ARCHITECTURES: ${{ matrix.backend == 'cuda' && matrix.cuda_architectures || '' }}
          CMAKE_BUILD_PARALLEL_LEVEL: ${{ env.BUILD_JOBS }}
          CC: gcc
          CXX: g++
        run: flutter build linux --release

      - name: Verify CUDA architectures cache (Linux)
        if: matrix.platform == 'linux' && matrix.backend == 'cuda'
        shell: bash
        run: |
          set -euo pipefail
          expected="CMAKE_CUDA_ARCHITECTURES:STRING=${{ matrix.cuda_architectures }}"
          mapfile -t cache_files < <(find aero_music_separator/build/linux -type f -name CMakeCache.txt | sort)
          if [ "${#cache_files[@]}" -eq 0 ]; then
            echo "CMakeCache.txt not found under aero_music_separator/build/linux"
            exit 1
          fi
          matched=0
          for cache_file in "${cache_files[@]}"; do
            if grep -F "${expected}" "${cache_file}" >/dev/null; then
              echo "Matched '${expected}' in ${cache_file}"
              matched=1
              break
            fi
          done
          if [ "${matched}" -ne 1 ]; then
            echo "Expected '${expected}' not found in any Linux CMakeCache.txt"
            for cache_file in "${cache_files[@]}"; do
              echo "Inspecting ${cache_file}"
              grep -n '^CMAKE_CUDA_ARCHITECTURES:STRING=' "${cache_file}" || true
            done
            exit 1
          fi

      - name: Build Windows app
        if: matrix.platform == 'windows'
        working-directory: W:\aero_music_separator
        env:
          AMS_NATIVE_BACKEND: ${{ matrix.backend }}
          AMS_CUDA_ARCHITECTURES: ${{ matrix.backend == 'cuda' && matrix.cuda_architectures || '' }}
          CMAKE_BUILD_PARALLEL_LEVEL: ${{ env.BUILD_JOBS }}
          CUDAFLAGS: ${{ matrix.cuda_flags || '' }}
          CL: ${{ matrix.cl_flags || '' }}
        run: flutter build windows --release

      - name: Verify CUDA architectures cache (Windows)
        if: matrix.platform == 'windows' && matrix.backend == 'cuda'
        shell: pwsh
        run: |
          $expected = "CMAKE_CUDA_ARCHITECTURES:STRING=${{ matrix.cuda_architectures }}"
          $caches = Get-ChildItem -Path "W:\aero_music_separator\build\windows" -Filter "CMakeCache.txt" -Recurse -File | Sort-Object FullName
          if (-not $caches) {
            throw "CMakeCache.txt not found under W:\aero_music_separator\build\windows"
          }
          $matched = $false
          foreach ($cache in $caches) {
            if (Select-String -Path $cache.FullName -Pattern $expected -SimpleMatch) {
              Write-Host "Matched '$expected' in $($cache.FullName)"
              $matched = $true
              break
            }
          }
          if (-not $matched) {
            Write-Host "Expected '$expected' not found in any Windows CMakeCache.txt"
            foreach ($cache in $caches) {
              Write-Host "Inspecting $($cache.FullName)"
              Select-String -Path $cache.FullName -Pattern '^CMAKE_CUDA_ARCHITECTURES:STRING=' | ForEach-Object { $_.Line }
            }
            throw "CMAKE_CUDA_ARCHITECTURES mismatch"
          }

      - name: Build macOS app
        if: matrix.platform == 'macos'
        working-directory: aero_music_separator
        env:
          SCCACHE_DISABLE: '1'
          AMS_NATIVE_BACKEND: ${{ matrix.backend }}
          CMAKE_BUILD_PARALLEL_LEVEL: ${{ env.BUILD_JOBS }}
          CC: clang
          CXX: clang++
        run: flutter build macos --release

      - name: Build iOS app
        if: matrix.platform == 'ios'
        working-directory: aero_music_separator
        env:
          SCCACHE_DISABLE: '1'
          AMS_NATIVE_BACKEND: ${{ matrix.backend }}
          AMS_IOS_SIM_ARCHS: arm64
          AMS_IOS_CI_ARM64_ONLY: '1'
          AMS_FORCE_REBUILD_XCFRAMEWORK: '1'
          CMAKE_BUILD_PARALLEL_LEVEL: ${{ env.BUILD_JOBS }}
          CC: clang
          CXX: clang++
        run: flutter build ios --release --no-codesign

      - name: Unmap short workspace drive (Windows)
        if: ${{ matrix.platform == 'windows' && always() }}
        shell: pwsh
        run: |
          subst W: /D

      - name: OpenMP audit (Unix)
        if: runner.os != 'Windows' && matrix.platform != 'ios'
        shell: bash
        run: |
          echo "OpenMP audit for ${RUNNER_OS}/${{ matrix.platform }}"
          found=0
          while IFS= read -r cache; do
            lines="$(grep -E '^(GGML_OPENMP|GGML_OPENMP_ENABLED|OpenMP_.*):' "${cache}" || true)"
            if [ -n "${lines}" ]; then
              found=1
              echo "--- ${cache} ---"
              echo "${lines}"
            fi
          done < <(find aero_music_separator/build -type f -name CMakeCache.txt 2>/dev/null || true)

          if [ "${found}" -eq 0 ]; then
            echo "::warning::No OpenMP cache entries were found for this build."
          fi

      - name: OpenMP audit (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "OpenMP audit for Windows/${{ matrix.platform }}"
          $caches = Get-ChildItem "aero_music_separator/build" -Recurse -Filter "CMakeCache.txt" -ErrorAction SilentlyContinue
          $found = $false
          foreach ($cache in $caches) {
            $matches = Select-String -Path $cache.FullName -Pattern '^(GGML_OPENMP|GGML_OPENMP_ENABLED|OpenMP_.*):' -AllMatches
            if ($matches) {
              $found = $true
              Write-Host "--- $($cache.FullName) ---"
              $matches | ForEach-Object { Write-Host $_.Line }
            }
          }
          if (-not $found) {
            Write-Host "::warning::No OpenMP cache entries were found for this build."
          }

      - name: OpenMP audit (iOS)
        if: matrix.platform == 'ios'
        shell: bash
        run: |
          if grep -R "^GGML_OPENMP:BOOL=OFF$" aero_music_separator/build/native-ios >/dev/null 2>&1; then
            echo "iOS OpenMP policy confirmed: GGML_OPENMP=OFF"
          else
            echo "::warning::Could not confirm GGML_OPENMP=OFF from iOS build cache."
          fi

      - name: Assert backend runtime (Linux)
        if: matrix.platform == 'linux'
        shell: bash
        run: |
          bundle_dir="aero_music_separator/build/linux/x64/release/bundle"
          echo "Discovered ggml runtime libraries in Linux bundle:"
          find "${bundle_dir}" -type f -name 'libggml*' -print || true
          ffi_lib="$(find "${bundle_dir}" -type f -name 'libaero_separator_ffi.so' | head -n1)"
          if [ -z "${ffi_lib}" ]; then
            echo "Linux FFI library missing in bundle"
            exit 1
          fi
          if [ "${{ matrix.backend }}" = "vulkan" ]; then
            backend_lib="$(find "${bundle_dir}" -type f -name 'libggml-vulkan.so*' | head -n1 || true)"
            if [ -z "${backend_lib}" ]; then
              echo "Expected Vulkan backend library not found"
              exit 1
            fi
          elif [ "${{ matrix.backend }}" = "cuda" ]; then
            backend_lib="$(find "${bundle_dir}" -type f -name 'libggml-cuda.so*' | head -n1 || true)"
            if [ -z "${backend_lib}" ]; then
              echo "Expected CUDA backend library not found"
              exit 1
            fi
          fi

      - name: Assert backend runtime (Android)
        if: matrix.platform == 'android'
        shell: bash
        run: |
          android_build_dir=""
          for candidate in \
            "aero_music_separator/build/app" \
            "aero_music_separator/android/app/build"; do
            if [ -d "${candidate}" ]; then
              android_build_dir="${candidate}"
              break
            fi
          done
          if [ -z "${android_build_dir}" ]; then
            echo "Android app build directory not found"
            echo "Checked: aero_music_separator/build/app and aero_music_separator/android/app/build"
            exit 1
          fi
          echo "Inspecting Android build outputs in: ${android_build_dir}"

          ffi_lib="$(find "${android_build_dir}" -type f -name 'libaero_separator_ffi.so' | head -n1 || true)"
          if [ -z "${ffi_lib}" ]; then
            echo "Android FFI library not found in Gradle outputs"
            exit 1
          fi
          backend_lib="$(find "${android_build_dir}" -type f -name 'libggml-vulkan.so' | head -n1 || true)"
          if [ -z "${backend_lib}" ]; then
            echo "Expected Android Vulkan backend library not found"
            exit 1
          fi

      - name: Assert backend runtime (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          $releaseDir = Resolve-Path "aero_music_separator/build/windows/x64/runner/Release"
          Write-Host "Discovered ggml runtime libraries in Windows release bundle:"
          Get-ChildItem $releaseDir -Recurse -Filter "*ggml*.dll" -ErrorAction SilentlyContinue |
            Sort-Object FullName |
            ForEach-Object { Write-Host "  $($_.FullName)" }
          $ffi = Get-ChildItem $releaseDir -Recurse -Filter "aero_separator_ffi.dll" | Select-Object -First 1
          if (-not $ffi) {
            throw "Windows FFI DLL missing in release bundle"
          }
          if ("${{ matrix.backend }}" -eq "vulkan") {
            $backendDll = Get-ChildItem $releaseDir -Recurse -Filter "*ggml-vulkan*.dll" | Select-Object -First 1
            if (-not $backendDll) {
              throw "Expected Vulkan backend DLL not found"
            }
          } elseif ("${{ matrix.backend }}" -eq "cuda") {
            $backendDll = Get-ChildItem $releaseDir -Recurse -Filter "*ggml-cuda*.dll" | Select-Object -First 1
            if (-not $backendDll) {
              throw "Expected CUDA backend DLL not found"
            }
          }

      - name: Assert backend runtime (macOS)
        if: matrix.platform == 'macos'
        shell: bash
        run: |
          app_path="$(find aero_music_separator/build/macos/Build/Products/Release -maxdepth 1 -name '*.app' | head -n1)"
          if [ -z "${app_path}" ]; then
            echo "macOS app artifact not found"
            exit 1
          fi
          ffi_lib="${app_path}/Contents/Frameworks/libaero_separator_ffi.dylib"
          if [ ! -f "${ffi_lib}" ]; then
            echo "macOS FFI dylib missing in app bundle"
            exit 1
          fi
          echo "Discovered ggml runtime libraries in macOS app bundle:"
          find "${app_path}/Contents/Frameworks" -type f -name 'libggml*.dylib' -print || true
          if [ "${{ matrix.backend }}" = "metal" ]; then
            backend_lib="$(find "${app_path}/Contents/Frameworks" -type f -name 'libggml-metal*.dylib' | head -n1 || true)"
            if [ -z "${backend_lib}" ]; then
              echo "Expected Metal backend dylib not found"
              exit 1
            fi
          fi
          otool -L "${ffi_lib}"

      - name: Assert backend runtime (iOS)
        if: matrix.platform == 'ios'
        shell: bash
        run: |
          if [ ! -d "aero_music_separator/native/ios/AeroSeparatorFFI/AeroSeparatorFFI.xcframework" ]; then
            echo "iOS XCFramework was not generated"
            exit 1
          fi
          if [ ! -d "aero_music_separator/build/ios/iphoneos/Runner.app" ]; then
            echo "iOS Runner.app not found after build"
            exit 1
          fi
          if ! grep -R "^GGML_METAL:BOOL=ON$" aero_music_separator/build/native-ios >/dev/null 2>&1; then
            echo "iOS native build cache does not report GGML_METAL=ON"
            exit 1
          fi

      - name: Smoke test prepare flow (Linux)
        if: matrix.platform == 'linux'
        shell: bash
        run: |
          lib_path="$(find aero_music_separator/build/linux/x64/release/bundle -type f -name 'libaero_separator_ffi.so' | head -n1)"
          if [ -z "${lib_path}" ]; then
            echo "Linux FFI library not found for smoke test"
            exit 1
          fi
          if [ "${{ matrix.backend }}" = "cuda" ]; then
            if ! ldconfig -p 2>/dev/null | grep -q 'libcuda\.so\.1'; then
              echo "::warning::Skipping Linux CUDA smoke test because libcuda.so.1 is unavailable on this runner."
              echo "ldd for ${lib_path}:"
              ldd "${lib_path}" || true
              exit 0
            fi
          fi
          python3 aero_music_separator/native/tools/ffi_prepare_smoke.py \
            --library "${lib_path}" \
            --verify-ogg-opus \
            --verify-wav-variants

      - name: Smoke test prepare flow (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          function Print-DllDependents {
            param(
              [Parameter(Mandatory = $true)][string]$DllPath,
              [Parameter(Mandatory = $true)][string]$Label
            )

            Write-Host "::group::DLL dependents - $Label"
            if (-not (Test-Path $DllPath)) {
              Write-Host "not found: $DllPath"
              Write-Host "::endgroup::"
              return
            }

            $dumpbinCmd = Get-Command dumpbin -ErrorAction SilentlyContinue
            if ($dumpbinCmd) {
              & $dumpbinCmd.Source /nologo /dependents $DllPath
              if ($LASTEXITCODE -ne 0) {
                Write-Host "dumpbin failed with exit code $LASTEXITCODE"
              }
              Write-Host "::endgroup::"
              return
            }

            $linkCmd = Get-Command link -ErrorAction SilentlyContinue
            if ($linkCmd) {
              & $linkCmd.Source /dump /dependents $DllPath
              if ($LASTEXITCODE -ne 0) {
                Write-Host "link /dump failed with exit code $LASTEXITCODE"
              }
              Write-Host "::endgroup::"
              return
            }

            Write-Host "dumpbin/link not found; cannot print dependents."
            Write-Host "::endgroup::"
          }

          $releaseDir = Resolve-Path "aero_music_separator/build/windows/x64/runner/Release"
          $ffi = Get-ChildItem $releaseDir -Recurse -Filter "aero_separator_ffi.dll" | Select-Object -First 1
          if (-not $ffi) {
            throw "Windows FFI library not found for smoke test"
          }

          $dllDirs = @()
          $dllDirs += $ffi.Directory.FullName

          $ffmpegBin = Join-Path $PWD "aero_music_separator/native/third_party/ffmpeg/windows/x64/bin"
          if (Test-Path $ffmpegBin) {
            $dllDirs += $ffmpegBin
          }

          if ("${{ matrix.backend }}" -eq "cuda") {
            $nvcudaCandidates = @("C:\\Windows\\System32\\nvcuda.dll")
            if ($env:windir) {
              $nvcudaCandidates = @((Join-Path $env:windir "System32\\nvcuda.dll")) + $nvcudaCandidates
            }
            $nvcudaPath = $nvcudaCandidates | Where-Object { $_ -and (Test-Path $_) } | Select-Object -First 1

            if (-not $nvcudaPath) {
              Write-Host "::group::Windows CUDA smoke precheck"
              Write-Host "NVIDIA driver DLL nvcuda.dll not found on this runner."
              Write-Host "CUDA_PATH* environment variables:"
              Get-ChildItem Env: | Where-Object { $_.Name -like "CUDA_PATH*" } | Sort-Object Name | ForEach-Object {
                Write-Host ("  {0}={1}" -f $_.Name, $_.Value)
              }
              Write-Host "::endgroup::"

              Print-DllDependents -DllPath $ffi.FullName -Label "aero_separator_ffi.dll"

              $backendDll = Get-ChildItem $releaseDir -Recurse -Filter "*ggml-cuda*.dll" | Select-Object -First 1
              if ($backendDll) {
                Print-DllDependents -DllPath $backendDll.FullName -Label $backendDll.Name
              } else {
                Write-Host "::group::DLL dependents - ggml-cuda"
                Write-Host "not found in release dir"
                Write-Host "::endgroup::"
              }

              $avcodecDll = $null
              if (Test-Path $ffmpegBin) {
                $avcodecDll = Get-ChildItem $ffmpegBin -Filter "avcodec*.dll" | Select-Object -First 1
              }
              if ($avcodecDll) {
                Print-DllDependents -DllPath $avcodecDll.FullName -Label $avcodecDll.Name
              }

              Write-Host "::warning::Skipping CUDA smoke test because nvcuda.dll is unavailable on this runner."
              exit 0
            }
          }

          if ("${{ matrix.backend }}" -eq "cuda") {
            Get-ChildItem Env: | Where-Object { $_.Name -like "CUDA_PATH*" } | ForEach-Object {
              if ($_.Value) {
                $cudaBin = Join-Path $_.Value "bin"
                if (Test-Path $cudaBin) {
                  $dllDirs += $cudaBin
                }
              }
            }
          }

          Get-ChildItem $releaseDir -Recurse -Filter "*.dll" | ForEach-Object {
            $dllDirs += $_.DirectoryName
          }

          $dllDirs = $dllDirs | Where-Object { $_ -and (Test-Path $_) } | Select-Object -Unique

          $smokeArgs = @(
            "aero_music_separator/native/tools/ffi_prepare_smoke.py",
            "--library", $ffi.FullName,
            "--verify-ogg-opus",
            "--verify-wav-variants"
          )

          foreach ($dir in $dllDirs) {
            $smokeArgs += "--dll-dir"
            $smokeArgs += $dir
          }

          python @smokeArgs
          $smokeExit = $LASTEXITCODE

          if ($smokeExit -ne 0) {
            Write-Host "::group::Windows smoke diagnostics"
            Write-Host "Smoke exit code: $smokeExit"
            Write-Host "Backend: ${{ matrix.backend }}"
            Write-Host "FFI DLL: $($ffi.FullName)"

            Write-Host "CUDA_PATH* environment variables:"
            Get-ChildItem Env: | Where-Object { $_.Name -like "CUDA_PATH*" } | Sort-Object Name | ForEach-Object {
              Write-Host ("  {0}={1}" -f $_.Name, $_.Value)
            }

            Write-Host "Collected DLL search directories:"
            foreach ($dir in $dllDirs) {
              Write-Host "  $dir"
            }

            Write-Host "Release directory key DLL inventory:"
            Get-ChildItem $releaseDir -Recurse -File -Filter "*.dll" |
              Where-Object {
                $_.Name -match '^aero_separator_ffi\.dll$' -or
                $_.Name -match '^ggml-.*\.dll$' -or
                $_.Name -match '^av.*\.dll$'
              } |
              Sort-Object FullName |
              ForEach-Object { Write-Host "  $($_.FullName)" }
            Write-Host "::endgroup::"

            Print-DllDependents -DllPath $ffi.FullName -Label "aero_separator_ffi.dll"

            if ("${{ matrix.backend }}" -eq "cuda") {
              $backendDll = Get-ChildItem $releaseDir -Recurse -Filter "*ggml-cuda*.dll" | Select-Object -First 1
              if ($backendDll) {
                Print-DllDependents -DllPath $backendDll.FullName -Label $backendDll.Name
              } else {
                Write-Host "::group::DLL dependents - ggml-cuda"
                Write-Host "not found in release dir"
                Write-Host "::endgroup::"
              }
            } elseif ("${{ matrix.backend }}" -eq "vulkan") {
              $backendDll = Get-ChildItem $releaseDir -Recurse -Filter "*ggml-vulkan*.dll" | Select-Object -First 1
              if ($backendDll) {
                Print-DllDependents -DllPath $backendDll.FullName -Label $backendDll.Name
              } else {
                Write-Host "::group::DLL dependents - ggml-vulkan"
                Write-Host "not found in release dir"
                Write-Host "::endgroup::"
              }
            }

            $avcodecDll = $null
            if (Test-Path $ffmpegBin) {
              $avcodecDll = Get-ChildItem $ffmpegBin -Filter "avcodec*.dll" | Select-Object -First 1
            }
            if ($avcodecDll) {
              Print-DllDependents -DllPath $avcodecDll.FullName -Label $avcodecDll.Name
            } else {
              Write-Host "::group::DLL dependents - avcodec"
              Write-Host "not found in ffmpeg bin dir"
              Write-Host "::endgroup::"
            }
          }

          exit $smokeExit

      - name: Smoke test prepare flow (macOS)
        if: matrix.platform == 'macos'
        shell: bash
        run: |
          app_path="$(find aero_music_separator/build/macos/Build/Products/Release -maxdepth 1 -name '*.app' | head -n1)"
          if [ -z "${app_path}" ]; then
            echo "macOS app artifact not found for smoke test"
            exit 1
          fi
          ffi_lib="${app_path}/Contents/Frameworks/libaero_separator_ffi.dylib"
          if [ ! -f "${ffi_lib}" ]; then
            echo "macOS FFI dylib missing for smoke test"
            exit 1
          fi
          python3 aero_music_separator/native/tools/ffi_prepare_smoke.py \
            --library "${ffi_lib}" \
            --verify-ogg-opus \
            --verify-wav-variants

      - name: Upload app artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ matrix.artifact_path }}
          if-no-files-found: error
          retention-days: 7

      - name: Setup Python (integration)
        id: integration_setup_python
        if: always()
        continue-on-error: true
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install integration deps
        id: integration_install_deps
        if: always()
        continue-on-error: true
        run: |
          python -m pip install --upgrade pip
          python -m pip install numpy soundfile

      - name: Prepare integration workspace (Unix)
        id: integration_workspace_unix
        if: ${{ always() && runner.os != 'Windows' }}
        continue-on-error: true
        shell: bash
        run: mkdir -p .ci-integration

      - name: Prepare integration workspace (Windows)
        id: integration_workspace_windows
        if: ${{ always() && runner.os == 'Windows' }}
        continue-on-error: true
        shell: pwsh
        run: New-Item -ItemType Directory -Path ".ci-integration" -Force | Out-Null

      - name: Download integration model (Unix)
        id: integration_download_model_unix
        if: ${{ always() && runner.os != 'Windows' }}
        continue-on-error: true
        shell: bash
        run: |
          set -euo pipefail
          url="https://huggingface.co/chenmozhijin/BSRoformer-GGUF/resolve/main/anvuew/BS-RoFormer/BSRoformer-anvuew-Q4_0.gguf"
          out=".ci-integration/model.gguf"
          curl --fail --location --retry 3 --retry-delay 2 --connect-timeout 20 --max-time 300 "$url" --output "$out"
          size_bytes="$(wc -c < "$out" | tr -d ' ')"
          echo "[integration] downloaded model to $out (${size_bytes} bytes)"

      - name: Download integration model (Windows)
        id: integration_download_model_windows
        if: ${{ always() && runner.os == 'Windows' }}
        continue-on-error: true
        shell: pwsh
        run: |
          $url = "https://huggingface.co/chenmozhijin/BSRoformer-GGUF/resolve/main/anvuew/BS-RoFormer/BSRoformer-anvuew-Q4_0.gguf"
          $out = Join-Path $PWD ".ci-integration/model.gguf"
          $success = $false
          for ($attempt = 1; $attempt -le 3; $attempt++) {
            try {
              Invoke-WebRequest -Uri $url -OutFile $out -TimeoutSec 300
              $success = $true
              break
            } catch {
              Write-Host "::warning::Model download attempt $attempt failed: $($_.Exception.Message)"
              if ($attempt -lt 3) {
                Start-Sleep -Seconds 2
              }
            }
          }
          if (-not $success) {
            throw "Failed to download integration model after 3 attempts."
          }
          $size = (Get-Item $out).Length
          Write-Host "[integration] downloaded model to $out ($size bytes)"

      - name: Generate integration audio
        id: integration_generate_audio
        if: always()
        continue-on-error: true
        run: python BSRoformer.cpp/scripts/generate_test_audio.py --output .ci-integration/input.wav --duration 3.0 --sample-rate 44100

      - name: Desktop integration (Linux/macOS)
        id: integration_desktop_unix
        if: ${{ always() && (matrix.platform == 'linux' || matrix.platform == 'macos') }}
        continue-on-error: true
        shell: bash
        run: |
          set -euo pipefail
          report_path=".ci-integration/report-${{ matrix.id }}.json"
          model_path=".ci-integration/model.gguf"
          input_path=".ci-integration/input.wav"

          backends="cpu"

          if [ "${{ matrix.platform }}" = "linux" ]; then
            lib_path="$(find aero_music_separator/build/linux/x64/release/bundle -type f -name 'libaero_separator_ffi.so' | head -n1)"
            if [ -z "${lib_path}" ]; then
              echo "Linux FFI library not found for integration test"
              exit 1
            fi
          else
            app_path="$(find aero_music_separator/build/macos/Build/Products/Release -maxdepth 1 -name '*.app' | head -n1)"
            if [ -z "${app_path}" ]; then
              echo "macOS app artifact not found for integration test"
              exit 1
            fi
            lib_path="${app_path}/Contents/Frameworks/libaero_separator_ffi.dylib"
            if [ ! -f "${lib_path}" ]; then
              echo "macOS FFI dylib not found for integration test"
              exit 1
            fi
          fi

          python3 aero_music_separator/native/tools/ffi_pipeline_integration.py \
            --library "${lib_path}" \
            --model "${model_path}" \
            --input "${input_path}" \
            --backends "${backends}" \
            --min-bytes 1000 \
            --chunk-size 131072 \
            --overlap 2 \
            --duration-tolerance-ms 300 \
            --timeout-sec 600 \
            --report "${report_path}"

      - name: Desktop integration (Windows)
        id: integration_desktop_windows
        if: ${{ always() && matrix.platform == 'windows' }}
        continue-on-error: true
        shell: pwsh
        run: |
          $reportPath = Join-Path $PWD ".ci-integration/report-${{ matrix.id }}.json"
          $modelPath = Join-Path $PWD ".ci-integration/model.gguf"
          $inputPath = Join-Path $PWD ".ci-integration/input.wav"

          $releaseDir = Resolve-Path "aero_music_separator/build/windows/x64/runner/Release"
          $ffi = Get-ChildItem $releaseDir -Recurse -Filter "aero_separator_ffi.dll" | Select-Object -First 1
          if (-not $ffi) {
            throw "Windows FFI library not found for integration test"
          }

          $dllDirs = @()
          $dllDirs += $ffi.Directory.FullName

          $ffmpegBin = Join-Path $PWD "aero_music_separator/native/third_party/ffmpeg/windows/x64/bin"
          if (Test-Path $ffmpegBin) {
            $dllDirs += $ffmpegBin
            $env:AMS_FFMPEG_BIN_DIR = $ffmpegBin
          }

          Get-ChildItem $releaseDir -Recurse -Filter "*.dll" | ForEach-Object {
            $dllDirs += $_.DirectoryName
          }
          $dllDirs = $dllDirs | Where-Object { $_ -and (Test-Path $_) } | Select-Object -Unique
          $env:AMS_DLL_DIRS = [string]::Join([IO.Path]::PathSeparator, $dllDirs)

          $backends = "cpu"

          python aero_music_separator/native/tools/ffi_pipeline_integration.py `
            --library $ffi.FullName `
            --model $modelPath `
            --input $inputPath `
            --backends $backends `
            --min-bytes 1000 `
            --chunk-size 131072 `
            --overlap 2 `
            --duration-tolerance-ms 300 `
            --timeout-sec 600 `
            --report $reportPath

      - name: Android emulator integration
        id: integration_android_emulator
        if: ${{ always() && matrix.platform == 'android' }}
        continue-on-error: true
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 34
          arch: x86_64
          target: google_apis
          profile: pixel_6
          script: |
            set -euo pipefail
            cd "$GITHUB_WORKSPACE"

            python -m http.server 18080 --bind 127.0.0.1 --directory .ci-integration > .ci-integration/android-http.log 2>&1 &
            server_pid=$!
            trap 'kill ${server_pid} || true' EXIT

            cd aero_music_separator
            flutter test integration_test/native_pipeline_test.dart \
              -d emulator-5554 \
              --dart-define=AMS_IT_MODEL_URL=http://10.0.2.2:18080/model.gguf \
              --dart-define=AMS_IT_AUDIO_URL=http://10.0.2.2:18080/input.wav \
              --dart-define=AMS_IT_BACKENDS=auto,cpu \
              --dart-define=AMS_IT_CHUNK_SIZE=131072 \
              --dart-define=AMS_IT_OVERLAP=2 \
              --dart-define=AMS_IT_MIN_OUTPUT_BYTES=1000 \
              --dart-define=AMS_IT_DURATION_TOLERANCE_MS=300 \
              2>&1 | tee ../.ci-integration/android-integration.log

      - name: iOS simulator integration
        id: integration_ios_simulator
        if: ${{ always() && matrix.platform == 'ios' }}
        continue-on-error: true
        shell: bash
        env:
          AMS_IOS_SIM_ARCHS: arm64
          AMS_IOS_CI_ARM64_ONLY: '1'
          AMS_FORCE_REBUILD_XCFRAMEWORK: '1'
        run: |
          set -euo pipefail
          cd "${GITHUB_WORKSPACE}"

          python3 -m http.server 18081 --bind 127.0.0.1 --directory .ci-integration > .ci-integration/ios-http.log 2>&1 &
          server_pid=$!
          trap 'kill ${server_pid} || true' EXIT

          device_id="$(python3 - <<'PY'
          import json
          import subprocess

          raw = subprocess.check_output(
              ["xcrun", "simctl", "list", "devices", "available", "--json"],
              text=True,
          )
          payload = json.loads(raw)
          for runtime, devices in payload.get("devices", {}).items():
              if "iOS" not in runtime:
                  continue
              for dev in devices:
                  if dev.get("isAvailable") and str(dev.get("name", "")).startswith("iPhone"):
                      print(dev["udid"])
                      raise SystemExit(0)
          raise SystemExit("No available iOS simulator device found")
          PY
          )"

          xcrun simctl boot "${device_id}" || true
          xcrun simctl bootstatus "${device_id}" -b

          cd aero_music_separator
          flutter test integration_test/native_pipeline_test.dart \
            -d "${device_id}" \
            --dart-define=AMS_IT_MODEL_URL=http://127.0.0.1:18081/model.gguf \
            --dart-define=AMS_IT_AUDIO_URL=http://127.0.0.1:18081/input.wav \
            --dart-define=AMS_IT_BACKENDS=cpu \
            --dart-define=AMS_IT_CHUNK_SIZE=131072 \
            --dart-define=AMS_IT_OVERLAP=2 \
            --dart-define=AMS_IT_MIN_OUTPUT_BYTES=1000 \
            --dart-define=AMS_IT_DURATION_TOLERANCE_MS=300 \
            2>&1 | tee ../.ci-integration/ios-integration.log

      - name: Dump desktop integration report (Linux/macOS)
        if: ${{ always() && (matrix.platform == 'linux' || matrix.platform == 'macos') && steps.integration_desktop_unix.outcome != 'success' }}
        shell: bash
        run: |
          set +e
          echo "=== .ci-integration listing ==="
          ls -la .ci-integration || true
          shopt -s nullglob
          for report in .ci-integration/report-*.json; do
            echo "--- ${report} ---"
            cat "${report}" || true
          done

      - name: Dump desktop integration report (Windows)
        if: ${{ always() && matrix.platform == 'windows' && steps.integration_desktop_windows.outcome != 'success' }}
        shell: pwsh
        run: |
          Write-Host "=== .ci-integration listing ==="
          Get-ChildItem ".ci-integration" -Force -ErrorAction SilentlyContinue
          $reports = Get-ChildItem ".ci-integration" -Filter "report-*.json" -File -ErrorAction SilentlyContinue
          foreach ($report in $reports) {
            Write-Host "--- $($report.FullName) ---"
            Get-Content $report.FullName -Raw
          }

      - name: Integration warning summary
        id: integration_warning_summary
        if: always()
        shell: pwsh
        env:
          OUTCOME_SETUP_PY: ${{ steps.integration_setup_python.outcome }}
          OUTCOME_INSTALL_DEPS: ${{ steps.integration_install_deps.outcome }}
          OUTCOME_WORKSPACE_UNIX: ${{ steps.integration_workspace_unix.outcome }}
          OUTCOME_WORKSPACE_WINDOWS: ${{ steps.integration_workspace_windows.outcome }}
          OUTCOME_DOWNLOAD_MODEL_UNIX: ${{ steps.integration_download_model_unix.outcome }}
          OUTCOME_DOWNLOAD_MODEL_WINDOWS: ${{ steps.integration_download_model_windows.outcome }}
          OUTCOME_GENERATE_AUDIO: ${{ steps.integration_generate_audio.outcome }}
          OUTCOME_DESKTOP_UNIX: ${{ steps.integration_desktop_unix.outcome }}
          OUTCOME_DESKTOP_WINDOWS: ${{ steps.integration_desktop_windows.outcome }}
          OUTCOME_ANDROID: ${{ steps.integration_android_emulator.outcome }}
          OUTCOME_IOS: ${{ steps.integration_ios_simulator.outcome }}
        run: |
          $failOutcomes = @('failure', 'cancelled', 'timed_out')
          $checks = @{
            'integration_setup_python'    = $env:OUTCOME_SETUP_PY
            'integration_install_deps'    = $env:OUTCOME_INSTALL_DEPS
            'integration_workspace_unix'  = $env:OUTCOME_WORKSPACE_UNIX
            'integration_workspace_windows' = $env:OUTCOME_WORKSPACE_WINDOWS
            'integration_download_model_unix'  = $env:OUTCOME_DOWNLOAD_MODEL_UNIX
            'integration_download_model_windows' = $env:OUTCOME_DOWNLOAD_MODEL_WINDOWS
            'integration_generate_audio'  = $env:OUTCOME_GENERATE_AUDIO
            'integration_desktop_unix'    = $env:OUTCOME_DESKTOP_UNIX
            'integration_desktop_windows' = $env:OUTCOME_DESKTOP_WINDOWS
            'integration_android_emulator' = $env:OUTCOME_ANDROID
            'integration_ios_simulator'   = $env:OUTCOME_IOS
          }

          $warned = $false
          foreach ($entry in $checks.GetEnumerator()) {
            $name = $entry.Key
            $outcome = $entry.Value
            if ($failOutcomes -contains $outcome) {
              Write-Host "::warning::Integration step '$name' failed with outcome '$outcome'."
              $warned = $true
            }
          }

          if (-not $warned) {
            Write-Host "Integration summary: no failing outcomes (skipped is allowed)."
          }

      - name: Upload integration reports
        id: integration_upload_reports
        if: always()
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: integration-report-${{ matrix.id }}
          path: .ci-integration/**
          include-hidden-files: true
          if-no-files-found: warn
          retention-days: 7

  compliance-bundle:
    name: compliance-bundle
    needs: prepare-ffmpeg
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Download ffmpeg artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: ffmpeg-*
          path: aero_music_separator/native/third_party/ffmpeg
          merge-multiple: false

      - name: Generate compliance bundle
        shell: bash
        run: |
          python3 aero_music_separator/native/tools/compliance/generate_bundle.py \
            --repo-root "${GITHUB_WORKSPACE}" \
            --out "${GITHUB_WORKSPACE}/compliance-bundle" \
            --strict

      - name: Upload compliance bundle
        uses: actions/upload-artifact@v4
        with:
          name: compliance-bundle
          path: compliance-bundle/**
          if-no-files-found: error
          retention-days: 30
