name: Full Build CI

on:
  pull_request:
  push:
    branches: [main, master]
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      build_jobs:
        description: Parallel build jobs (auto or integer)
        required: false
        default: auto
        type: string

concurrency:
  group: full-build-${{ github.ref }}
  cancel-in-progress: true

env:
  AMS_FFMPEG_VERSION: n7.1.1
  AMS_LAME_VERSION: '3.100'
  BUILD_JOBS_INPUT: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.build_jobs || 'auto' }}

jobs:
  prepare-ffmpeg:
    name: ffmpeg-${{ matrix.id }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - id: linux-x86_64
            os: ubuntu-24.04
            platform: linux
            artifact_name: ffmpeg-linux-x86_64
            artifact_path: aero_music_separator/native/third_party/ffmpeg/linux/x86_64
            run_cmd: ./aero_music_separator/native/tools/ffmpeg/build_linux.sh x86_64
          - id: windows-x64
            os: windows-2025
            platform: windows
            artifact_name: ffmpeg-windows-x64
            artifact_path: aero_music_separator/native/third_party/ffmpeg/windows/x64
            run_cmd: .\aero_music_separator\native\tools\ffmpeg\build_windows.ps1 -Arch x64
          - id: macos-x86_64
            os: macos-15-intel
            platform: macos
            artifact_name: ffmpeg-macos-x86_64
            artifact_path: aero_music_separator/native/third_party/ffmpeg/macos/x86_64
            run_cmd: ./aero_music_separator/native/tools/ffmpeg/build_macos.sh x86_64
          - id: macos-arm64
            os: macos-14
            platform: macos
            artifact_name: ffmpeg-macos-arm64
            artifact_path: aero_music_separator/native/third_party/ffmpeg/macos/arm64
            run_cmd: ./aero_music_separator/native/tools/ffmpeg/build_macos.sh arm64
          - id: ios-device-sim-arm64
            os: macos-14
            platform: ios
            artifact_name: ffmpeg-ios-device-sim-arm64
            artifact_path: aero_music_separator/native/third_party/ffmpeg/ios
            run_cmd: ./aero_music_separator/native/tools/ffmpeg/build_ios.sh arm64
          - id: android-arm64-v8a
            os: ubuntu-24.04
            platform: android
            artifact_name: ffmpeg-android-arm64-v8a
            artifact_path: aero_music_separator/native/third_party/ffmpeg/android/arm64-v8a
            run_cmd: ./aero_music_separator/native/tools/ffmpeg/build_android.sh arm64-v8a
          - id: android-armeabi-v7a
            os: ubuntu-24.04
            platform: android
            artifact_name: ffmpeg-android-armeabi-v7a
            artifact_path: aero_music_separator/native/third_party/ffmpeg/android/armeabi-v7a
            run_cmd: ./aero_music_separator/native/tools/ffmpeg/build_android.sh armeabi-v7a
          - id: android-x86_64
            os: ubuntu-24.04
            platform: android
            artifact_name: ffmpeg-android-x86_64
            artifact_path: aero_music_separator/native/third_party/ffmpeg/android/x86_64
            run_cmd: ./aero_music_separator/native/tools/ffmpeg/build_android.sh x86_64

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Linux deps
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            autoconf \
            automake \
            libtool \
            pkg-config \
            make \
            nasm \
            yasm \
            python3 \
            cmake \
            ninja-build \
            curl \
            git

      - name: Install macOS deps
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install autoconf automake libtool pkg-config nasm yasm sccache

      - name: Setup MSYS2 (Windows)
        if: runner.os == 'Windows'
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            base-devel
            make
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-autotools
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-make
            mingw-w64-x86_64-nasm
            mingw-w64-x86_64-yasm
            mingw-w64-x86_64-pkgconf
            mingw-w64-x86_64-python

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Cache ffmpeg sources/build
        uses: actions/cache@v4
        with:
          path: |
            .cache/ffmpeg-src
            .cache/ffmpeg-build
            ~/.cache/sccache
            ~/Library/Caches/Mozilla.sccache
            ~\AppData\Local\Mozilla\sccache
          key: ffmpeg-${{ matrix.id }}-${{ env.AMS_FFMPEG_VERSION }}-${{ env.AMS_LAME_VERSION }}-${{ hashFiles('aero_music_separator/native/tools/ffmpeg/**') }}

      - name: Setup Android SDK
        if: matrix.platform == 'android'
        uses: android-actions/setup-android@v3

      - name: Install Android NDK
        if: matrix.platform == 'android'
        run: sdkmanager "ndk;27.2.12479018"

      - name: Build ffmpeg (Unix)
        if: runner.os != 'Windows'
        shell: bash
        env:
          ANDROID_NDK_HOME: /usr/local/lib/android/sdk/ndk/27.2.12479018
          AMS_USE_SCCACHE: 'ON'
        run: |
          chmod +x aero_music_separator/native/tools/ffmpeg/*.sh
          ${{ matrix.run_cmd }}

      - name: Build ffmpeg (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: ${{ matrix.run_cmd }}

      - name: sccache stats (Unix)
        if: runner.os != 'Windows'
        run: sccache --show-stats || true

      - name: sccache stats (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: sccache --show-stats

      - name: Verify ffmpeg manifest license profile (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          python3 aero_music_separator/native/tools/ffmpeg/verify_manifest_license.py \
            --manifest "${{ matrix.artifact_path }}/manifest.json"

      - name: Verify ffmpeg manifest license profile (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          python aero_music_separator/native/tools/ffmpeg/verify_manifest_license.py `
            --manifest "${{ matrix.artifact_path }}/manifest.json"

      - name: Upload ffmpeg artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ matrix.artifact_path }}
          if-no-files-found: error
          retention-days: 7

  build-app:
    name: app-${{ matrix.id }}
    needs: prepare-ffmpeg
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - id: android-vulkan-release
            os: ubuntu-24.04
            platform: android
            backend: vulkan
            artifact_name: app-android-vulkan-release
            artifact_path: aero_music_separator/android/app/build/outputs/**
          - id: linux-vulkan-release
            os: ubuntu-24.04
            platform: linux
            backend: vulkan
            artifact_name: app-linux-vulkan-release
            artifact_path: aero_music_separator/build/linux/x64/release/bundle/**
          - id: linux-cuda-11_8-release
            os: ubuntu-22.04
            platform: linux
            backend: cuda
            cuda_version: '11.8.0'
            artifact_name: app-linux-cuda-11_8-release
            artifact_path: aero_music_separator/build/linux/x64/release/bundle/**
          - id: linux-cuda-12_9-release
            os: ubuntu-24.04
            platform: linux
            backend: cuda
            cuda_version: '12.9.1'
            artifact_name: app-linux-cuda-12_9-release
            artifact_path: aero_music_separator/build/linux/x64/release/bundle/**
          - id: linux-cuda-13_1-release
            os: ubuntu-24.04
            platform: linux
            backend: cuda
            cuda_version: '13.1.0'
            artifact_name: app-linux-cuda-13_1-release
            artifact_path: aero_music_separator/build/linux/x64/release/bundle/**
          - id: windows-vulkan-release
            os: windows-2025
            platform: windows
            backend: vulkan
            artifact_name: app-windows-vulkan-release
            artifact_path: aero_music_separator/build/windows/x64/runner/Release/**
          - id: windows-cuda-11_8-release
            os: windows-2025
            platform: windows
            backend: cuda
            cuda_version: '11.8.0'
            artifact_name: app-windows-cuda-11_8-release
            artifact_path: aero_music_separator/build/windows/x64/runner/Release/**
          - id: windows-cuda-12_9-release
            os: windows-2025
            platform: windows
            backend: cuda
            cuda_version: '12.9.1'
            artifact_name: app-windows-cuda-12_9-release
            artifact_path: aero_music_separator/build/windows/x64/runner/Release/**
          - id: windows-cuda-13_1-release
            os: windows-2025
            platform: windows
            backend: cuda
            cuda_version: '13.1.0'
            artifact_name: app-windows-cuda-13_1-release
            artifact_path: aero_music_separator/build/windows/x64/runner/Release/**
          - id: macos-metal-x86_64-release
            os: macos-15-intel
            platform: macos
            backend: metal
            ffmpeg_artifact: ffmpeg-macos-x86_64
            ffmpeg_root: aero_music_separator/native/third_party/ffmpeg/macos/x86_64
            artifact_name: app-macos-metal-x86_64-release
            artifact_path: aero_music_separator/build/macos/Build/Products/Release/*.app
          - id: macos-metal-arm64-release
            os: macos-14
            platform: macos
            backend: metal
            ffmpeg_artifact: ffmpeg-macos-arm64
            ffmpeg_root: aero_music_separator/native/third_party/ffmpeg/macos/arm64
            artifact_name: app-macos-metal-arm64-release
            artifact_path: aero_music_separator/build/macos/Build/Products/Release/*.app
          - id: ios-metal-release
            os: macos-14
            platform: ios
            backend: metal
            ffmpeg_artifact: ffmpeg-ios-device-sim-arm64
            ffmpeg_root: aero_music_separator/native/third_party/ffmpeg/ios
            artifact_name: app-ios-metal-release
            artifact_path: aero_music_separator/build/ios/iphoneos/*.app

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Setup Java (Android)
        if: matrix.platform == 'android'
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup Android SDK
        if: matrix.platform == 'android'
        uses: android-actions/setup-android@v3

      - name: Install Android NDK/CMake
        if: matrix.platform == 'android'
        run: sdkmanager "ndk;27.2.12479018" "cmake;3.22.1"

      - name: Install Linux build deps
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang \
            cmake \
            ninja-build \
            pkg-config \
            libgtk-3-dev \
            liblzma-dev \
            libstdc++-12-dev \
            ffmpeg
          if [ "${{ matrix.backend }}" = "vulkan" ]; then
            sudo apt-get install -y libvulkan-dev
            sudo apt-get install -y glslc || sudo apt-get install -y glslang-tools
          fi

      - name: Install macOS build deps
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install cmake ninja pkg-config libomp ffmpeg
          if ! command -v pod >/dev/null 2>&1; then
            brew install cocoapods
          fi

      - name: Install Windows build deps
        if: runner.os == 'Windows'
        shell: pwsh
        run: choco install ninja ffmpeg -y

      - name: Install Vulkan SDK (Windows Vulkan backend)
        if: runner.os == 'Windows' && matrix.backend == 'vulkan'
        shell: pwsh
        run: |
          $VK_VERSION = "1.4.313.2"
          curl.exe -o VulkanSDK.exe -L "https://sdk.lunarg.com/sdk/download/${VK_VERSION}/windows/vulkansdk-windows-X64-${VK_VERSION}.exe"
          Start-Process -FilePath .\VulkanSDK.exe -ArgumentList "--accept-licenses --default-answer --confirm-command install" -Wait
          Add-Content $env:GITHUB_ENV "VULKAN_SDK=C:\VulkanSDK\${VK_VERSION}"
          Add-Content $env:GITHUB_PATH "C:\VulkanSDK\${VK_VERSION}\bin"

      - name: Setup MSVC
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Setup sccache
        if: matrix.platform != 'macos' && matrix.platform != 'ios'
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Resolve build jobs (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          if [ -z "${BUILD_JOBS_INPUT}" ] || [ "${BUILD_JOBS_INPUT}" = "auto" ]; then
            jobs="$(nproc 2>/dev/null || sysctl -n hw.logicalcpu)"
          else
            jobs="${BUILD_JOBS_INPUT}"
          fi
          echo "BUILD_JOBS=${jobs}" >> "$GITHUB_ENV"

      - name: Resolve build jobs (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          if ([string]::IsNullOrWhiteSpace($env:BUILD_JOBS_INPUT) -or $env:BUILD_JOBS_INPUT -eq 'auto') {
            $jobs = $env:NUMBER_OF_PROCESSORS
          } else {
            $jobs = $env:BUILD_JOBS_INPUT
          }
          Add-Content $env:GITHUB_ENV "BUILD_JOBS=$jobs"

      - name: Download ffmpeg (Linux)
        if: matrix.platform == 'linux'
        uses: actions/download-artifact@v4
        with:
          name: ffmpeg-linux-x86_64
          path: aero_music_separator/native/third_party/ffmpeg/linux/x86_64

      - name: Download ffmpeg (Windows)
        if: matrix.platform == 'windows'
        uses: actions/download-artifact@v4
        with:
          name: ffmpeg-windows-x64
          path: aero_music_separator/native/third_party/ffmpeg/windows/x64

      - name: Download ffmpeg (macOS)
        if: matrix.platform == 'macos'
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.ffmpeg_artifact }}
          path: ${{ matrix.ffmpeg_root }}

      - name: Download ffmpeg (iOS)
        if: matrix.platform == 'ios'
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.ffmpeg_artifact }}
          path: ${{ matrix.ffmpeg_root }}

      - name: Download ffmpeg (Android arm64-v8a)
        if: matrix.platform == 'android'
        uses: actions/download-artifact@v4
        with:
          name: ffmpeg-android-arm64-v8a
          path: aero_music_separator/native/third_party/ffmpeg/android/arm64-v8a

      - name: Download ffmpeg (Android armeabi-v7a)
        if: matrix.platform == 'android'
        uses: actions/download-artifact@v4
        with:
          name: ffmpeg-android-armeabi-v7a
          path: aero_music_separator/native/third_party/ffmpeg/android/armeabi-v7a

      - name: Download ffmpeg (Android x86_64)
        if: matrix.platform == 'android'
        uses: actions/download-artifact@v4
        with:
          name: ffmpeg-android-x86_64
          path: aero_music_separator/native/third_party/ffmpeg/android/x86_64

      - name: Install CUDA Toolkit (Linux)
        if: runner.os == 'Linux' && matrix.backend == 'cuda'
        uses: Jimver/cuda-toolkit@master
        with:
          cuda: ${{ matrix.cuda_version }}
          method: network
          sub-packages: '["nvcc", "cudart", "thrust"]'
          non-cuda-sub-packages: '["libcublas", "libcublas-dev"]'

      - name: Install CUDA Toolkit (Windows)
        if: runner.os == 'Windows' && matrix.backend == 'cuda' && matrix.cuda_version != '13.1.0'
        uses: Jimver/cuda-toolkit@master
        with:
          cuda: ${{ matrix.cuda_version }}
          method: network
          sub-packages: '["nvcc", "cudart", "cublas", "cublas_dev", "thrust", "visual_studio_integration"]'

      - name: Install CUDA Toolkit (Windows 13.1.0)
        if: runner.os == 'Windows' && matrix.backend == 'cuda' && matrix.cuda_version == '13.1.0'
        uses: Jimver/cuda-toolkit@master
        with:
          cuda: ${{ matrix.cuda_version }}
          method: network
          sub-packages: '["nvcc", "cudart", "cublas", "cublas_dev", "nvrtc", "nvrtc_dev", "crt", "nvvm", "visual_studio_integration"]'

      - name: Flutter pub get
        working-directory: aero_music_separator
        run: flutter pub get

      - name: Build Android app
        if: matrix.platform == 'android'
        working-directory: aero_music_separator/android
        env:
          ANDROID_NDK_HOME: /usr/local/lib/android/sdk/ndk/27.2.12479018
          AMS_NATIVE_BACKEND: ${{ matrix.backend }}
        run: |
          chmod +x ./gradlew
          ./gradlew :app:assembleRelease --stacktrace --parallel --max-workers=${BUILD_JOBS}

      - name: Build Linux app
        if: matrix.platform == 'linux'
        working-directory: aero_music_separator
        env:
          AMS_NATIVE_BACKEND: ${{ matrix.backend }}
        run: flutter build linux --release

      - name: Build Windows app
        if: matrix.platform == 'windows'
        working-directory: aero_music_separator
        env:
          AMS_NATIVE_BACKEND: ${{ matrix.backend }}
        run: flutter build windows --release

      - name: Build macOS app
        if: matrix.platform == 'macos'
        working-directory: aero_music_separator
        env:
          SCCACHE_DISABLE: '1'
          AMS_NATIVE_BACKEND: ${{ matrix.backend }}
          CC: clang
          CXX: clang++
        run: flutter build macos --release

      - name: Build iOS app
        if: matrix.platform == 'ios'
        working-directory: aero_music_separator
        env:
          SCCACHE_DISABLE: '1'
          AMS_NATIVE_BACKEND: ${{ matrix.backend }}
          CC: clang
          CXX: clang++
        run: flutter build ios --release --no-codesign

      - name: Assert backend runtime (Linux)
        if: matrix.platform == 'linux'
        shell: bash
        run: |
          bundle_dir="aero_music_separator/build/linux/x64/release/bundle"
          ffi_lib="$(find "${bundle_dir}" -type f -name 'libaero_separator_ffi.so' | head -n1)"
          if [ -z "${ffi_lib}" ]; then
            echo "Linux FFI library missing in bundle"
            exit 1
          fi
          if [ "${{ matrix.backend }}" = "vulkan" ]; then
            backend_lib="$(find "${bundle_dir}" -type f -name 'libggml-vulkan*.so' | head -n1 || true)"
            if [ -z "${backend_lib}" ]; then
              echo "Expected Vulkan backend library not found"
              exit 1
            fi
          elif [ "${{ matrix.backend }}" = "cuda" ]; then
            backend_lib="$(find "${bundle_dir}" -type f -name 'libggml-cuda*.so' | head -n1 || true)"
            if [ -z "${backend_lib}" ]; then
              echo "Expected CUDA backend library not found"
              exit 1
            fi
          fi

      - name: Assert backend runtime (Android)
        if: matrix.platform == 'android'
        shell: bash
        run: |
          ffi_lib="$(find aero_music_separator/android/app/build -type f -name 'libaero_separator_ffi.so' | head -n1 || true)"
          if [ -z "${ffi_lib}" ]; then
            echo "Android FFI library not found in Gradle outputs"
            exit 1
          fi
          backend_lib="$(find aero_music_separator/android/app/build -type f -name 'libggml-vulkan.so' | head -n1 || true)"
          if [ -z "${backend_lib}" ]; then
            echo "Expected Android Vulkan backend library not found"
            exit 1
          fi

      - name: Assert backend runtime (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          $releaseDir = Resolve-Path "aero_music_separator/build/windows/x64/runner/Release"
          $ffi = Get-ChildItem $releaseDir -Recurse -Filter "aero_separator_ffi.dll" | Select-Object -First 1
          if (-not $ffi) {
            throw "Windows FFI DLL missing in release bundle"
          }
          if ("${{ matrix.backend }}" -eq "vulkan") {
            $backendDll = Get-ChildItem $releaseDir -Recurse -Filter "*ggml-vulkan*.dll" | Select-Object -First 1
            if (-not $backendDll) {
              throw "Expected Vulkan backend DLL not found"
            }
          } elseif ("${{ matrix.backend }}" -eq "cuda") {
            $backendDll = Get-ChildItem $releaseDir -Recurse -Filter "*ggml-cuda*.dll" | Select-Object -First 1
            if (-not $backendDll) {
              throw "Expected CUDA backend DLL not found"
            }
          }

      - name: Assert backend runtime (macOS)
        if: matrix.platform == 'macos'
        shell: bash
        run: |
          app_path="$(find aero_music_separator/build/macos/Build/Products/Release -maxdepth 1 -name '*.app' | head -n1)"
          if [ -z "${app_path}" ]; then
            echo "macOS app artifact not found"
            exit 1
          fi
          ffi_lib="${app_path}/Contents/Frameworks/libaero_separator_ffi.dylib"
          if [ ! -f "${ffi_lib}" ]; then
            echo "macOS FFI dylib missing in app bundle"
            exit 1
          fi
          if [ "${{ matrix.backend }}" = "metal" ]; then
            backend_lib="$(find "${app_path}/Contents/Frameworks" -type f -name 'libggml-metal*.dylib' | head -n1 || true)"
            if [ -z "${backend_lib}" ]; then
              echo "Expected Metal backend dylib not found"
              exit 1
            fi
          fi
          otool -L "${ffi_lib}"

      - name: Assert backend runtime (iOS)
        if: matrix.platform == 'ios'
        shell: bash
        run: |
          if [ ! -d "aero_music_separator/native/ios/AeroSeparatorFFI/AeroSeparatorFFI.xcframework" ]; then
            echo "iOS XCFramework was not generated"
            exit 1
          fi
          if [ ! -d "aero_music_separator/build/ios/iphoneos/Runner.app" ]; then
            echo "iOS Runner.app not found after build"
            exit 1
          fi
          if ! grep -R "^GGML_METAL:BOOL=ON$" aero_music_separator/build/native-ios >/dev/null 2>&1; then
            echo "iOS native build cache does not report GGML_METAL=ON"
            exit 1
          fi

      - name: Smoke test prepare flow (Linux)
        if: matrix.platform == 'linux'
        shell: bash
        run: |
          lib_path="$(find aero_music_separator/build/linux/x64/release/bundle -type f -name 'libaero_separator_ffi.so' | head -n1)"
          if [ -z "${lib_path}" ]; then
            echo "Linux FFI library not found for smoke test"
            exit 1
          fi
          python3 aero_music_separator/native/tools/ffi_prepare_smoke.py \
            --library "${lib_path}" \
            --verify-ogg-opus \
            --verify-wav-variants

      - name: Smoke test prepare flow (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          $releaseDir = Resolve-Path "aero_music_separator/build/windows/x64/runner/Release"
          $ffi = Get-ChildItem $releaseDir -Recurse -Filter "aero_separator_ffi.dll" | Select-Object -First 1
          if (-not $ffi) {
            throw "Windows FFI library not found for smoke test"
          }

          $dllDirs = @()
          $dllDirs += $ffi.Directory.FullName

          $ffmpegBin = Join-Path $PWD "aero_music_separator/native/third_party/ffmpeg/windows/x64/bin"
          if (Test-Path $ffmpegBin) {
            $dllDirs += $ffmpegBin
          }

          Get-ChildItem $releaseDir -Recurse -Filter "*.dll" | ForEach-Object {
            $dllDirs += $_.DirectoryName
          }

          $dllDirs = $dllDirs | Where-Object { $_ -and (Test-Path $_) } | Select-Object -Unique

          $smokeArgs = @(
            "aero_music_separator/native/tools/ffi_prepare_smoke.py",
            "--library", $ffi.FullName,
            "--verify-ogg-opus",
            "--verify-wav-variants"
          )

          foreach ($dir in $dllDirs) {
            $smokeArgs += "--dll-dir"
            $smokeArgs += $dir
          }

          python @smokeArgs

      - name: Smoke test prepare flow (macOS)
        if: matrix.platform == 'macos'
        shell: bash
        run: |
          app_path="$(find aero_music_separator/build/macos/Build/Products/Release -maxdepth 1 -name '*.app' | head -n1)"
          if [ -z "${app_path}" ]; then
            echo "macOS app artifact not found for smoke test"
            exit 1
          fi
          ffi_lib="${app_path}/Contents/Frameworks/libaero_separator_ffi.dylib"
          if [ ! -f "${ffi_lib}" ]; then
            echo "macOS FFI dylib missing for smoke test"
            exit 1
          fi
          python3 aero_music_separator/native/tools/ffi_prepare_smoke.py \
            --library "${ffi_lib}" \
            --verify-ogg-opus \
            --verify-wav-variants

      - name: sccache stats (Unix)
        if: runner.os != 'Windows' && matrix.platform != 'macos' && matrix.platform != 'ios'
        run: sccache --show-stats || true

      - name: sccache stats (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: sccache --show-stats

      - name: Upload app artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ matrix.artifact_path }}
          if-no-files-found: error
          retention-days: 7

  compliance-bundle:
    name: compliance-bundle
    needs: prepare-ffmpeg
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Download ffmpeg artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: ffmpeg-*
          path: aero_music_separator/native/third_party/ffmpeg
          merge-multiple: false

      - name: Generate compliance bundle
        shell: bash
        run: |
          python3 aero_music_separator/native/tools/compliance/generate_bundle.py \
            --repo-root "${GITHUB_WORKSPACE}" \
            --out "${GITHUB_WORKSPACE}/compliance-bundle" \
            --strict

      - name: Upload compliance bundle
        uses: actions/upload-artifact@v4
        with:
          name: compliance-bundle
          path: compliance-bundle/**
          if-no-files-found: error
          retention-days: 30
